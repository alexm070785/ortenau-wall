<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lokal eintragen – Ortenau-Wall</title>
  <style>
    :root{
      --bg:#f6f6f6; --card:#fff; --line:#e5e7eb; --text:#1f2937;
      --muted:#6b7280; --primary:#0ea5e9; --primary-600:#0284c7;
      --danger:#ef4444; --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .wrap{max-width:900px;margin:0 auto;padding:14px 16px}
    h1{margin:0;font-size:20px}
    a.back{color:var(--primary);text-decoration:none}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .pad{padding:16px}
    form{display:grid;gap:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;font:inherit}
    textarea{min-height:90px;resize:vertical}
    .muted{font-size:12px;color:var(--muted)}
    .help{margin-top:-8px}
    .actions{display:flex;gap:10px;align-items:center}
    button{appearance:none;border:1px solid var(--line);background:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    button.primary:hover{background:var(--primary-600)}
    .msg{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#f9fafb;display:none}
    .msg.ok{display:block;border-color:#bbf7d0;background:#ecfdf5}
    .msg.err{display:block;border-color:#fecaca;background:#fff1f2;color:#991b1b}
    .preview{display:flex;gap:12px;align-items:center}
    .preview img{width:96px;height:96px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .tag{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center">
      <h1>Lokal eintragen</h1>
      <a class="back" href="index.html">← Zurück zur Startseite</a>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="pad">
        <p class="tag">
          Fülle die Felder aus. Nach dem Absenden erscheint dein Eintrag im Admin als
          <b>„pending“</b> und wird nach Freigabe auf der Startseite angezeigt.
        </p>

        <div id="msg" class="msg"></div>

        <form id="entryForm" enctype="multipart/form-data" novalidate>
          <div class="row">
            <div>
              <label for="name">Name des Lokals *</label>
              <input id="name" name="name" type="text" required>
            </div>
            <div>
              <label for="category">Kategorie *</label>
              <select id="category" name="category" required>
                <option value="" disabled selected>Bitte wählen…</option>
                <option value="restaurant">Restaurant</option>
                <option value="pizzeria">Pizzeria</option>
                <option value="doener">Döner</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="city">Stadt/Ort</label>
              <input id="city" name="city" type="text" placeholder="z. B. Offenburg">
            </div>
            <div>
              <label for="address">Adresse</label>
              <input id="address" name="address" type="text" placeholder="Straße Nr.">
            </div>
          </div>

          <div class="row">
            <div>
              <label for="website">Website</label>
              <input id="website" name="website" type="url" placeholder="https://…">
            </div>
            <div>
              <label for="phone">Telefon</label>
              <input id="phone" name="phone" type="tel">
            </div>
          </div>

          <div>
            <label>Öffnungszeiten (optional)</label>
            <div id="hoursList"></div>
            <div class="actions">
              <button type="button" id="addHour">+ Zeile</button>
              <span class="muted">Beispiel: „Mo–Fr 11–22“</span>
            </div>
            <!-- wird vor dem Senden befüllt -->
            <textarea id="hours_json" name="hours_json" class="visually-hidden" aria-hidden="true"></textarea>
          </div>

          <div>
            <label for="image">Bild/Logo (optional)</label>
            <input id="image" name="image" type="file" accept="image/*">
            <div class="help muted">max. 4 MB · JPG/PNG/WebP</div>
            <div class="preview" id="preview" style="display:none">
              <img id="previewImg" alt="Vorschau">
              <span class="muted" id="previewName"></span>
            </div>
          </div>

          <div class="actions">
            <button class="primary" type="submit">Eintrag absenden</button>
            <button type="reset" id="resetBtn">Zurücksetzen</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // ---- Öffnungszeiten: dynamische Felder → JSON in hidden textarea ----
    (function(){
      const list = document.getElementById('hoursList');
      const addBtn = document.getElementById('addHour');
      const hidden = document.getElementById('hours_json');

      function row(value=''){
        const wrap = document.createElement('div');
        wrap.className = 'row';
        wrap.style.gridTemplateColumns = '1fr auto';
        wrap.innerHTML = `
          <input type="text" class="hour" placeholder="z. B. Mo–Fr 11–22" value="${value}">
          <button type="button" class="remove">Entfernen</button>
        `;
        wrap.querySelector('.remove').addEventListener('click', () => { wrap.remove(); sync(); });
        wrap.querySelector('.hour').addEventListener('input', sync);
        return wrap;
      }
      function sync(){
        const vals = [...list.querySelectorAll('.hour')].map(i=>i.value.trim()).filter(Boolean);
        hidden.value = JSON.stringify(vals);
      }
      addBtn.addEventListener('click', () => { list.appendChild(row()); sync(); });
      // eine Start-Zeile
      list.appendChild(row()); sync();
    })();

    // ---- Bildvorschau + Limit ----
    (function(){
      const input = document.getElementById('image');
      const prev = document.getElementById('preview');
      const img  = document.getElementById('previewImg');
      const name = document.getElementById('previewName');

      input.addEventListener('change', () => {
        prev.style.display = 'none';
        const f = input.files && input.files[0];
        if(!f) return;
        if (f.size > 4*1024*1024) { alert('Die Datei ist größer als 4 MB.'); input.value=''; return; }
        const url = URL.createObjectURL(f);
        img.src = url; name.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`;
        prev.style.display = 'flex';
      });
      document.getElementById('resetBtn').addEventListener('click', ()=>{ prev.style.display='none'; name.textContent=''; });
    })();

    // ---- Senden an Netlify Function ----
    (function(){
      const form = document.getElementById('entryForm');
      const msg  = document.getElementById('msg');

      function show(type, text){
        msg.className = 'msg ' + (type==='ok'?'ok':'err');
        msg.textContent = text;
        msg.style.display = 'block';
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.style.display='block'; msg.className='msg'; msg.textContent='Sende…';

        // required Felder
        if(!form.name.value.trim() || !form.category.value){
          show('err', 'Bitte Name und Kategorie ausfüllen.');
          return;
        }

        const fd = new FormData(form);
        // hours_json ist bereits im hidden Feld – sicherstellen, dass es existiert
        if (!fd.get('hours_json') || !fd.get('hours_json').trim()) fd.set('hours_json', '[]');

        try{
          const res = await fetch('/.netlify/functions/entries-create', { method:'POST', body: fd });
          const data = await res.json().catch(()=> ({}));
          if(!res.ok) throw new Error(data?.error || ('HTTP '+res.status));

          show('ok', 'Danke! Dein Eintrag wurde gespeichert und wartet auf Freigabe. (ID: '+data.id+')');
          form.reset();
          document.getElementById('preview').style.display='none';
        }catch(err){
          console.error(err);
          show('err', 'Fehler beim Absenden: ' + err.message);
        }
      });
    })();
  </script>
</body>
</html>
