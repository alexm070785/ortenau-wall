<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin – Einträge verwalten</title>
<style>
  :root{
    --bg:#f6f6f6; --card:#fff; --text:#222; --muted:#70798C; --radius:12px;
    --border:#d0d0d0; --shadow:0 4px 12px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:24px}
  h1{margin:0 0 16px}
  .wrap{max-width:960px;margin:auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  label{font-weight:600;display:block;margin:6px 0}
  input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
  textarea{min-height:88px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  .muted{color:var(--muted);font-size:.92rem}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  button{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;background:#222;color:#fff}
  button.secondary{background:#efefef;color:#222;border:1px solid var(--border)}
  button.danger{background:#8b0000}
  .bar{display:flex;gap:12px;align-items:center;margin:16px 0}
  .bar input{max-width:260px}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa}
  .right{text-align:right}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ddd;font-size:.85rem;background:#fafafa}
  @media (max-width:760px){ .g2,.g3,.row{grid-template-columns:1fr} .bar{flex-direction:column;align-items:flex-start} }
</style>

<div class="wrap">
  <h1>Admin – Eintrag hinzufügen</h1>

  <div class="card grid g2" role="form">
    <div>
      <label for="titel">Name des Lokals *</label>
      <input id="titel" required placeholder="Bella Pizza">
    </div>
    <div>
      <label for="kategorie">Kategorie *</label>
      <select id="kategorie">
        <option value="restaurant">Restaurant</option>
        <option value="pizzeria">Pizzeria</option>
        <option value="pizza">Pizza</option>
        <option value="doener">Döner</option>
        <option value="cafe">Café</option>
        <option value="imbiss">Imbiss</option>
        <option value="bäckerei">Bäckerei</option>
      </select>
    </div>

    <div>
      <label for="strasse">Straße & Nr.</label>
      <input id="strasse" placeholder="Hauptstr. 12">
    </div>
    <div class="row">
      <div>
        <label for="plz">PLZ</label>
        <input id="plz" placeholder="77652">
      </div>
      <div>
        <label for="stadt">Ort / Stadt</label>
        <input id="stadt" placeholder="Offenburg">
      </div>
    </div>

    <div>
      <label for="telefon">Telefon</label>
      <input id="telefon" placeholder="+49 781 …">
    </div>
    <div>
      <label for="email">E-Mail</label>
      <input id="email" type="email" placeholder="info@beispiel.de">
    </div>

    <div>
      <label for="website">Website</label>
      <input id="website" placeholder="https://…">
    </div>
    <div>
      <label for="speisekarte">Speisekarte-URL</label>
      <input id="speisekarte" placeholder="https://…/speisekarte.pdf">
    </div>

    <div class="g2" style="grid-column:1/-1;display:grid;gap:12px">
      <div>
        <label for="oeffnungszeiten">Öffnungszeiten</label>
        <textarea id="oeffnungszeiten" placeholder="Mo–Fr 11–22; Sa 12–23; So geschlossen"></textarea>
      </div>
      <div>
        <label for="schliesstage">Schließtage / Hinweise</label>
        <textarea id="schliesstage" placeholder="Feiertage geschlossen; Betriebsferien 1.–15. Aug."></textarea>
      </div>
    </div>

    <div>
      <label for="beschreibung">Kurzbeschreibung</label>
      <textarea id="beschreibung" placeholder="Hausgemachte Pasta & Steinofenpizza …"></textarea>
    </div>
    <div>
      <label for="preisklasse">Preisniveau</label>
      <select id="preisklasse">
        <option value="">–</option>
        <option value="€">€ Günstig</option>
        <option value="€€">€€ Mittel</option>
        <option value="€€€">€€€ Höher</option>
      </select>
    </div>

    <div>
      <label for="bild">Bild/Icon-URL</label>
      <input id="bild" placeholder="https://…/bild.jpg">
    </div>
    <div>
      <label for="url">Externe Seite (Detail/Bestellen)</label>
      <input id="url" placeholder="https://…">
    </div>

    <div class="g3" style="grid-column:1/-1;display:grid;gap:12px">
      <div>
        <label for="instagram">Instagram</label>
        <input id="instagram" placeholder="https://instagram.com/…">
      </div>
      <div>
        <label for="facebook">Facebook</label>
        <input id="facebook" placeholder="https://facebook.com/…">
      </div>
      <div>
        <label for="tiktok">TikTok</label>
        <input id="tiktok" placeholder="https://tiktok.com/@…">
      </div>
    </div>

    <div class="row" style="grid-column:1/-1">
      <label style="display:flex;gap:18px;align-items:center;font-weight:600">
        <span><input type="checkbox" id="abholung"> Abholung</span>
        <span><input type="checkbox" id="lieferung"> Lieferung</span>
        <span><input type="checkbox" id="featured"> Featured (Top)</span>
      </label>
      <div class="muted">Tipp: Nur wenige Einträge als „Featured“ markieren.</div>
    </div>

    <div style="grid-column:1/-1">
      <label for="token">Admin-Token (nur nötig, wenn in Netlify gesetzt)</label>
      <input id="token" placeholder="optional – NETLIFY_ADMIN_TOKEN">
      <div class="muted">Wenn in Netlify ein <b>NETLIFY_ADMIN_TOKEN</b> existiert, hier denselben Wert eintragen.</div>
    </div>

    <div class="actions" style="grid-column:1/-1">
      <button id="save">Speichern</button>
      <button id="fetch" class="secondary" type="button">Liste laden</button>
      <button id="exportBtn" class="secondary" type="button">Export (JSON)</button>
      <label class="secondary" style="padding:0;display:inline-flex;align-items:center;">
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <span style="padding:10px 14px;display:inline-block;cursor:pointer">Import (JSON)</span>
      </label>
      <button id="clear" class="danger" type="button">ALLE löschen</button>
    </div>
  </div>

  <div class="bar">
    <input id="filter" placeholder="Liste filtern …">
    <span class="muted">Nur Anzeige – Daten bleiben auf dem Server.</span>
  </div>

  <div class="card">
    <table>
      <thead><tr>
        <th>Titel</th><th>Kategorie</th><th>Ort</th><th>Telefon</th><th class="right">Links</th>
      </tr></thead>
      <tbody id="tbody"><tr><td colspan="5" class="muted">Noch nichts geladen.</td></tr></tbody>
    </table>
  </div>
</div>

<script>
const API = "/api/entries";

function hdrs(){
  const h = {"Content-Type":"application/json"};
  const t = document.getElementById('token').value.trim();
  if(t) h["x-admin-token"]=t;
  return h;
}
function toPayload(){
  const titel = document.getElementById('titel').value.trim();
  const stadt = document.getElementById('stadt').value.trim();
  const kategorie = document.getElementById('kategorie').value;

  return {
    titel, stadt, kategorie,
    url: document.getElementById('url').value.trim(),
    adresse: { strasse: document.getElementById('strasse').value.trim(), plz: document.getElementById('plz').value.trim(), stadt },
    kontakt: { telefon: document.getElementById('telefon').value.trim(), email: document.getElementById('email').value.trim() },
    web: {
      website: document.getElementById('website').value.trim(),
      speisekarte: document.getElementById('speisekarte').value.trim(),
      instagram: document.getElementById('instagram').value.trim(),
      facebook: document.getElementById('facebook').value.trim(),
      tiktok: document.getElementById('tiktok').value.trim()
    },
    info: {
      oeffnungszeiten: document.getElementById('oeffnungszeiten').value.trim(),
      schliesstage: document.getElementById('schliesstage').value.trim(),
      beschreibung: document.getElementById('beschreibung').value.trim(),
      preisklasse: document.getElementById('preisklasse').value
    },
    optionen: {
      abholung: document.getElementById('abholung').checked,
      lieferung: document.getElementById('lieferung').checked,
      featured: document.getElementById('featured').checked
    },
    bild: document.getElementById('bild').value.trim()
  };
}

async function loadList(){
  const r = await fetch(API);
  const data = await r.json();
  renderTable(data);
}
function renderTable(items){
  const tb = document.getElementById('tbody');
  tb.innerHTML='';
  if(!items.length){ tb.innerHTML='<tr><td colspan="5" class="muted">Keine Einträge gespeichert.</td></tr>'; return; }
  const q = document.getElementById('filter').value.trim().toLowerCase();
  items
    .filter(i => !q || JSON.stringify(i).toLowerCase().includes(q))
    .forEach(i=>{
      const tr = document.createElement('tr');
      const ort = i.stadt || i?.adresse?.stadt || '';
      const tel = i?.kontakt?.telefon || '';
      tr.innerHTML = `
        <td>${i.titel || ''}</td>
        <td><span class="pill">${i.kategorie||''}</span></td>
        <td>${ort}</td>
        <td>${tel}</td>
        <td class="right">
          ${i.url ? `<a href="${i.url}" target="_blank" rel="noopener">Seite</a>` : ''}
          ${i.web?.website ? ` · <a href="${i.web.website}" target="_blank" rel="noopener">Website</a>` : ''}
          ${i.web?.speisekarte ? ` · <a href="${i.web.speisekarte}" target="_blank" rel="noopener">Speisekarte</a>` : ''}
        </td>`;
      tb.appendChild(tr);
    });
}

document.getElementById('save').onclick = async (e)=>{
  e.preventDefault();
  const p = toPayload();
  if(!p.titel){ alert('Bitte einen Namen eingeben.'); return; }
  const res = await fetch(API, { method:"POST", headers:hdrs(), body:JSON.stringify(p) }).then(r=>r.json());
  if(res.error){ alert('Fehler: ' + res.error); return; }
  alert('Gespeichert!');
  loadList();
};
document.getElementById('fetch').onclick = loadList;
document.getElementById('clear').onclick = async ()=>{
  if(!confirm('WIRKLICH alle Einträge löschen?')) return;
  const res = await fetch(API, { method:"DELETE", headers:hdrs() }).then(r=>r.json());
  if(res.error){ alert('Fehler: ' + res.error); return; }
  alert('Alles gelöscht.'); loadList();
};
document.getElementById('filter').addEventListener('input', loadList);
document.getElementById('exportBtn').onclick = async ()=>{
  const r = await fetch(API); const data = await r.json();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'eintraege.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
document.getElementById('importFile').onchange = async (ev)=>{
  const file = ev.target.files[0]; if(!file) return;
  const text = await file.text(); let arr;
  try { arr = JSON.parse(text); } catch { alert('Ungültiges JSON.'); return; }
  if(!Array.isArray(arr)){ alert('Erwarte ein Array von Einträgen.'); return; }
  if(!confirm('Import ersetzt die komplette Liste. Fortfahren?')) return;
  for(const it of arr){ await fetch(API, { method:"POST", headers:hdrs(), body:JSON.stringify(it) }); }
  alert('Import abgeschlossen.'); loadList();
};
loadList();
</script>
