<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#f6f6f6">
<title>Admin ‚Äì Eintr√§ge verwalten</title>
<style>
  :root{
    --bg:#f6f6f6; --card:#fff; --text:#222; --muted:#70798C; --radius:12px;
    --border:#d0d0d0; --shadow:0 4px 12px rgba(0,0,0,.08); --tap:48px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  *{box-sizing:border-box}
  html{font-size:16px}
  @media (max-width:480px){ html{font-size:17px} }
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:16px}
  h1{margin:4px 0 16px}
  .wrap{max-width:960px;margin:auto}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:760px){ .g2,.g3{grid-template-columns:1fr} }
  label{font-weight:600;display:block;margin:6px 0}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:1rem;min-height:44px}
  textarea{min-height:100px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:760px){ .row{grid-template-columns:1fr} }
  .muted{color:var(--muted);font-size:.95rem}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;background:#222;color:#fff;min-height:var(--tap)}
  button.secondary{background:#efefef;color:#222;border:1px solid var(--border)}
  button.danger{background:#8b0000}
  .bar{display:flex;gap:12px;align-items:center;margin:16px 0;flex-wrap:wrap}
  .bar input{max-width:260px;min-height:var(--tap)}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa}
  .right{text-align:right}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #ddd;font-size:.9rem;background:#fafafa}
  .menu-wrap{grid-column:1/-1}
  .menu-editor{font-family:var(--mono);min-height:260px}
  .menu-meta{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:6px;flex-wrap:wrap}
  .menu-preview{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:10px;white-space:pre-wrap;line-height:1.5}
  .menu-preview h3{margin:14px 0 6px;font-size:1.05rem}
  .menu-preview .price{opacity:.9}
</style>

<div class="wrap">
  <h1>Admin ‚Äì Eintrag hinzuf√ºgen / bearbeiten</h1>

  <div class="card grid g2" role="form">
    <div>
      <label for="titel">Name des Lokals *</label>
      <input id="titel" required placeholder="Genc D√∂ner & Pizza">
    </div>
    <div>
      <label for="kategorie">Kategorie *</label>
      <select id="kategorie">
        <option value="restaurant">Restaurant</option>
        <option value="pizzeria">Pizzeria</option>
        <option value="pizza">Pizza</option>
        <option value="d√∂ner">D√∂ner/Kebab</option>
        <option value="kebab">Kebab</option>
        <option value="cafe">Caf√©</option>
        <option value="imbiss">Imbiss</option>
        <option value="b√§ckerei">B√§ckerei</option>
      </select>
    </div>

    <div>
      <label for="strasse">Stra√üe & Nr.</label>
      <input id="strasse" placeholder="Hauptstr. 12">
    </div>
    <div class="row">
      <div>
        <label for="plz">PLZ</label>
        <input id="plz" placeholder="77652" inputmode="numeric">
      </div>
      <div>
        <label for="stadt">Ort / Stadt</label>
        <input id="stadt" placeholder="Offenburg">
      </div>
    </div>

    <div>
      <label for="telefon">Telefon</label>
      <input id="telefon" placeholder="+49 781 ‚Ä¶" inputmode="tel">
    </div>
    <div>
      <label for="email">E-Mail</label>
      <input id="email" type="email" placeholder="info@beispiel.de">
    </div>

    <div>
      <label for="website">Website</label>
      <input id="website" placeholder="https://‚Ä¶">
    </div>
    <div>
      <label for="speisekarte">Speisekarte-URL (optional)</label>
      <input id="speisekarte" placeholder="https://‚Ä¶/speisekarte.pdf">
    </div>

    <div>
      <label for="oeffnungszeiten">√ñffnungszeiten</label>
      <textarea id="oeffnungszeiten" placeholder="Mo‚ÄìFr 11‚Äì22; Sa 12‚Äì23; So geschlossen"></textarea>
    </div>
    <div>
      <label for="schliesstage">Schlie√ütage / Hinweise</label>
      <textarea id="schliesstage" placeholder="Feiertage geschlossen; Betriebsferien 1.‚Äì15. Aug."></textarea>
    </div>

    <div class="menu-wrap">
      <label for="menuText">Speisekarte ‚Äì Text (lang)</label>
      <textarea id="menuText" class="menu-editor" placeholder="Hier den kompletten Speisekarten-Text einf√ºgen ‚Ä¶"></textarea>
      <div class="menu-meta">
        <div class="muted">Zeilenumbr√ºche bleiben erhalten. Emojis wie ü•ô/ü•ó/üçï/ü•§ als √úberschriften m√∂glich.</div>
        <div class="muted"><span id="menuCount">0</span> Zeichen</div>
      </div>
      <div class="menu-preview" id="menuPreview" aria-live="polite">Vorschau erscheint hier ‚Ä¶</div>
    </div>

    <div>
      <label for="beschreibung">Kurzbeschreibung</label>
      <textarea id="beschreibung" placeholder="Hausgemachte Pasta & Steinofenpizza ‚Ä¶"></textarea>
    </div>
    <div>
      <label for="preisklasse">Preisniveau</label>
      <select id="preisklasse">
        <option value="">‚Äì</option>
        <option value="‚Ç¨">‚Ç¨ G√ºnstig</option>
        <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ Mittel</option>
        <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ H√∂her</option>
      </select>
    </div>

    <div>
      <label for="bild">Bild/Icon-URL</label>
      <input id="bild" placeholder="https://‚Ä¶/bild.jpg">
    </div>
    <div>
      <label for="url">Externe Seite (Detail/Bestellen)</label>
      <input id="url" placeholder="https://‚Ä¶">
    </div>

    <div class="g3" style="grid-column:1/-1;display:grid;gap:12px">
      <div>
        <label for="instagram">Instagram</label>
        <input id="instagram" placeholder="https://instagram.com/‚Ä¶">
      </div>
      <div>
        <label for="facebook">Facebook</label>
        <input id="facebook" placeholder="https://facebook.com/‚Ä¶">
      </div>
      <div>
        <label for="tiktok">TikTok</label>
        <input id="tiktok" placeholder="https://tiktok.com/@‚Ä¶">
      </div>
    </div>

    <div class="row" style="grid-column:1/-1">
      <label style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;font-weight:600">
        <span><input type="checkbox" id="abholung"> Abholung</span>
        <span><input type="checkbox" id="lieferung"> Lieferung</span>
        <span><input type="checkbox" id="featured"> Featured (Top)</span>
      </label>
      <div class="muted">Tipp: Nur wenige Eintr√§ge als ‚ÄûFeatured‚Äú markieren.</div>
    </div>

    <div style="grid-column:1/-1">
      <label for="token">Admin-Token (nur n√∂tig, wenn in Netlify gesetzt)</label>
      <input id="token" placeholder="optional ‚Äì NETLIFY_ADMIN_TOKEN">
      <div class="muted">Falls du in Netlify die Variable <b>NETLIFY_ADMIN_TOKEN</b> gesetzt hast, trage hier denselben Wert ein. Sonst leer lassen.</div>
    </div>

    <div class="actions" style="grid-column:1/-1">
      <button id="save">Speichern</button>
      <button id="fetch" class="secondary" type="button">Liste laden</button>
      <button id="exportBtn" class="secondary" type="button">Export (JSON)</button>
      <label class="secondary" style="padding:0;display:inline-flex;align-items:center;">
        <input id="importFile" type="file" accept=".json,.txt,.html,text/html,application/json" style="display:none">
        <span style="padding:12px 16px;display:inline-block;cursor:pointer">Import (JSON/HTML)</span>
      </label>
      <button id="clear" class="danger" type="button">ALLE l√∂schen</button>
    </div>
  </div>

  <div class="bar">
    <input id="filter" placeholder="Liste filtern ‚Ä¶">
    <span class="muted">Nur Anzeige ‚Äì Daten bleiben auf dem Server.</span>
  </div>

  <div class="card">
    <table>
      <thead><tr>
        <th>Titel</th><th>Kategorie</th><th>Ort</th><th>Telefon</th><th class="right">Links</th><th></th>
      </tr></thead>
      <tbody id="tbody"><tr><td colspan="6" class="muted">Noch nichts geladen.</td></tr></tbody>
    </table>
  </div>
</div>

<script>
const API = "/api/entries";
const $ = s => document.querySelector(s);
let editingId = null;

// Men√º-Vorschau
function renderMenuPreview(txt){
  const box = $("#menuPreview");
  if(!txt.trim()){ box.textContent = "Vorschau erscheint hier ‚Ä¶"; return; }
  const lines = txt.replace(/\r\n/g,"\n").split("\n");
  const parts = [];
  const esc = s => s.replace(/[&<>\"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  for(let i=0;i<lines.length;i++){
    const l = lines[i].trim();
    if(!l){ parts.push("<br>"); continue; }
    const next = lines[i+1]?.trim() || "";
    const looksPrice = /‚Ç¨|\d,\d{2}/.test(next);
    if(!/‚Ç¨|\d,\d{2}/.test(l) && looksPrice){
      parts.push(`<p>${esc(l)}<br><span class="price">${esc(next)}</span></p>`); i++; continue;
    }
    parts.push(`<p>${esc(l)}</p>`);
  }
  box.innerHTML = parts.join("\n");
}
const menuTA = $("#menuText"), menuCount = $("#menuCount");
function autoResize(){ menuTA.style.height="auto"; menuTA.style.height=(menuTA.scrollHeight+4)+"px"; }
function updateMenuUI(){ menuCount.textContent = menuTA.value.length; autoResize(); renderMenuPreview(menuTA.value); }
menuTA.addEventListener("input", updateMenuUI); updateMenuUI();

function hdrs(){
  const h = {"Content-Type":"application/json"};
  const t = $("#token").value.trim();
  if(t) h["x-admin-token"]=t;
  return h;
}
function toPayload(){
  const titel = $("#titel").value.trim();
  const stadt = $("#stadt").value.trim();
  const kategorie = $("#kategorie").value;
  return {
    id: editingId || undefined,
    titel, stadt, kategorie,
    url: $("#url").value.trim(),
    adresse: { strasse: $("#strasse").value.trim(), plz: $("#plz").value.trim(), stadt },
    kontakt: { telefon: $("#telefon").value.trim(), email: $("#email").value.trim() },
    web: {
      website: $("#website").value.trim(), speisekarte: $("#speisekarte").value.trim(),
      instagram: $("#instagram").value.trim(), facebook: $("#facebook").value.trim(), tiktok: $("#tiktok").value.trim()
    },
    info: {
      oeffnungszeiten: $("#oeffnungszeiten").value.trim(),
      schliesstage: $("#schliesstage").value.trim(),
      beschreibung: $("#beschreibung").value.trim(),
      preisklasse: $("#preisklasse").value
    },
    optionen: { abholung: $("#abholung").checked, lieferung: $("#lieferung").checked, featured: $("#featured").checked },
    bild: $("#bild").value.trim(),
    menu: { text: $("#menuText").value }
  };
}

async function loadList(){
  const r = await fetch(API,{cache:"no-store"});
  const data = await r.json().catch(()=>[]);
  renderTable(Array.isArray(data)?data:[]);
}

function renderTable(items){
  const tb = $("#tbody");
  tb.innerHTML='';
  if(!items.length){ tb.innerHTML='<tr><td colspan="6" class="muted">Keine Eintr√§ge gespeichert.</td></tr>'; return; }
  const q = $("#filter").value.trim().toLowerCase();
  items
    .filter(i => !q || JSON.stringify(i).toLowerCase().includes(q))
    .forEach(i=>{
      const tr = document.createElement('tr');
      const ort = i.stadt || i?.adresse?.stadt || '';
      const tel = i?.kontakt?.telefon || '';
      tr.innerHTML = `
        <td>${i.titel || ''}</td>
        <td><span class="pill">${(i.kategorie||'').replace(/doener|d√∂ner|kebab/i,'D√∂ner/Kebab')}</span></td>
        <td>${ort}</td>
        <td>${tel}</td>
        <td class="right">
          ${i.url ? `<a href="${i.url}" target="_blank" rel="noopener">Seite</a>` : ''}
          ${i.web?.website ? ` ¬∑ <a href="${i.web.website}" target="_blank" rel="noopener">Website</a>` : ''}
          ${i.web?.speisekarte ? ` ¬∑ <a href="${i.web.speisekarte}" target="_blank" rel="noopener">Speisekarte</a>` : ''}
        </td>
        <td class="right">
          <button data-id="${i.id||''}" class="editBtn">Bearbeiten</button>
          <button data-id="${i.id||''}" class="delBtn danger" style="margin-left:6px">L√∂schen</button>
        </td>`;
      tb.appendChild(tr);
    });

  tb.querySelectorAll('.editBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id){ alert('Dieser Eintrag hat noch keine ID ‚Äì bitte neu anlegen.'); return; }
      const r = await fetch(API,{cache:"no-store"}); const data = await r.json().catch(()=>[]);
      const item = (Array.isArray(data)?data:[]).find(x=>x.id===id);
      if(!item){ alert('Eintrag nicht gefunden.'); return; }
      editingId = id;
      $("#titel").value = item.titel||"";
      $("#kategorie").value = item.kategorie||"restaurant";
      $("#strasse").value = item.adresse?.strasse||"";
      $("#plz").value = item.adresse?.plz||"";
      $("#stadt").value = item.stadt || item.adresse?.stadt || "";
      $("#telefon").value = item.kontakt?.telefon||"";
      $("#email").value = item.kontakt?.email||"";
      $("#website").value = item.web?.website||"";
      $("#speisekarte").value = item.web?.speisekarte||"";
      $("#oeffnungszeiten").value = item.info?.oeffnungszeiten||"";
      $("#schliesstage").value = item.info?.schliesstage||"";
      $("#beschreibung").value = item.info?.beschreibung||"";
      $("#preisklasse").value = item.info?.preisklasse||"";
      $("#bild").value = item.bild||"";
      $("#url").value = item.url||"";
      $("#instagram").value = item.web?.instagram||"";
      $("#facebook").value = item.web?.facebook||"";
      $("#tiktok").value = item.web?.tiktok||"";
      $("#abholung").checked = !!item.optionen?.abholung;
      $("#lieferung").checked = !!item.optionen?.lieferung;
      $("#featured").checked = !!item.optionen?.featured;
      $("#menuText").value = item.menu?.text || "";
      updateMenuUI();
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  tb.querySelectorAll('.delBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id) return;
      if(!confirm('Diesen Eintrag wirklich l√∂schen?')) return;
      const res = await fetch(`${API}?id=${encodeURIComponent(id)}`, { method:"DELETE", headers:hdrs() })
                        .then(r=>r.json()).catch(()=>({error:"Request failed"}));
      if(res && res.error){ alert('Fehler: ' + res.error); return; }
      loadList();
    });
  });
}

$("#save").onclick = async (e)=>{
  e.preventDefault();
  const p = toPayload();
  if(!p.titel){ alert('Bitte einen Namen eingeben.'); return; }
  const method = editingId ? "PUT" : "POST";
  const res = await fetch(API, { method, headers:hdrs(), body:JSON.stringify(p) })
                    .then(r=>r.json()).catch(()=>({error:"Request failed"}));
  if(res && res.error){ alert('Fehler: ' + res.error + '\n\nHinweis: Wenn NETLIFY_ADMIN_TOKEN gesetzt ist, trage es oben in das Token-Feld ein.'); return; }
  alert(editingId ? 'Aktualisiert!' : 'Gespeichert!');
  editingId = null;
  loadList();
};
$("#fetch").onclick = loadList;
$("#clear").onclick = async ()=>{
  if(!confirm('WIRKLICH alle Eintr√§ge l√∂schen?')) return;
  const res = await fetch(API, { method:"DELETE", headers:hdrs() })
                    .then(r=>r.json()).catch(()=>({error:"Request failed"}));
  if(res && res.error){ alert('Fehler: ' + res.error); return; }
  alert('Alles gel√∂scht.');
  loadList();
};
$("#filter").addEventListener('input', loadList);

// Export
$("#exportBtn").onclick = async ()=>{
  const r = await fetch(API,{cache:"no-store"}); const data = await r.json().catch(()=>[]);
  const blob = new Blob([JSON.stringify(Array.isArray(data)?data:[],null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'eintraege.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

// -------------- ROBUSTER IMPORT -----------------
function tryJson(t){ try{ return JSON.parse(t); } catch{ return null; } }
function extractArrayFromHtml(htmlText){
  // Finde den gr√∂√üten JSON-Array-Block in einer HTML-Seite
  const match = htmlText.match(/\[[\s\S]*\]/);
  if(!match) return null;
  return tryJson(match[0]);
}

$("#importFile").onchange = async (ev)=>{
  const file = ev.target.files[0]; if(!file) return;
  let text = await file.text();
  text = text.replace(/^\uFEFF/,'').trim(); // BOM weg

  let data = tryJson(text);

  // HTML? -> versuche Array aus HTML zu ziehen
  if(!data && /^</.test(text)) data = extractArrayFromHtml(text);

  // Objekt-Wrapper?
  if(!Array.isArray(data)){
    const obj = tryJson(text);
    if(obj){
      if(Array.isArray(obj)) data = obj;
      else if(Array.isArray(obj.entries)) data = obj.entries;
      else if(Array.isArray(obj.items)) data = obj.items;
      else if(Array.isArray(obj.data)) data = obj.data;
      else if(typeof obj.value === "string") data = tryJson(obj.value);
      else if(typeof obj.data === "string") data = tryJson(obj.data);
    }
  }

  if(!Array.isArray(data)){
    alert("Ung√ºltiges JSON.\nErwartet wird eine JSON-Liste (Array) mit Eintr√§gen.\nTipp: Auch HTML-Downloads werden jetzt unterst√ºtzt ‚Äì bitte die richtige Datei w√§hlen.");
    return;
  }

  if(!confirm(`Es werden ${data.length} Eintr√§ge importiert/aktualisiert. Fortfahren?`)) return;

  // vorhandene mit id -> PUT, neue -> POST
  let okCount=0, failCount=0;
  for(const it of data){
    const method = it && it.id ? "PUT" : "POST";
    try{
      await fetch(API, { method, headers:hdrs(), body:JSON.stringify(it) });
      okCount++;
    }catch{ failCount++; }
  }
  alert(`Import abgeschlossen.\nErfolgreich: ${okCount}${failCount?`  Fehler: ${failCount}`:''}`);
  loadList();
};

loadList();
</script>
