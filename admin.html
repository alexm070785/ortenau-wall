<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ortenau-Wall ¬∑ Admin</title>
<style>
  :root{
    --accent:#e7e7e7; --text:#4f4f4f; --bg:#f6f6f6; --card:#fff;
    --muted:#70798C; --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.08);
    --shadowHover:0 6px 18px rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);}
  header{position:sticky;top:0;z-index:10;background:var(--accent);border-bottom:1px solid #b0b0b0}
  .head{max-width:1160px;margin:0 auto;display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 16px;}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid #d0d0d0;background:#fff;cursor:pointer;box-shadow:var(--shadow)}
  .btn:hover{box-shadow:var(--shadowHover)}
  .btn.primary{background:#4f4f4f;color:#fff;border-color:#4f4f4f}
  .wrap{max-width:1160px;margin:16px auto;padding:0 16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-start;padding:8px}
  .pill{padding:7px 12px;border:1px solid #d0d0d0;border-radius:999px;background:#fff;cursor:pointer}
  .pill.active{background:#e9e9e9;font-weight:700}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;font-size:.95rem}
  th{background:#fafafa}
  .muted{color:var(--muted)}
  #toast{position:fixed;right:16px;bottom:56px;background:#2d7a3e;color:#fff;padding:12px 14px;border-radius:10px;box-shadow:var(--shadow);
         opacity:0;transform:translateY(8px);transition:all .25s;z-index:9999}
</style>
</head>
<body>

<header>
  <div class="head">
    <div style="display:flex;gap:8px;align-items:center">
      <strong>Ortenau-Wall ¬∑ Admin</strong>
      <span class="muted" data-admin-email></span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="pill" id="tabPending"  data-tab="pending">Pending</button>
      <button class="pill" id="tabApproved" data-tab="approved">Approved</button>
      <button class="btn" id="refreshBtn">üîÑ Aktualisieren</button>
      <button class="btn" id="loginBtn"  data-login>üîê Login</button>
      <button class="btn" id="logoutBtn" data-logout>üö™ Logout</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="toolbar">
      <span class="muted">Warteschlange</span>
    </div>
    <div style="overflow:auto">
      <table aria-label="Eintr√§ge">
        <thead>
          <tr>
            <th style="width:80px">Bild</th>
            <th>Name &amp; Adresse</th>
            <th>Ort</th>
            <th>Kat.</th>
            <th>Eingereicht</th>
            <th style="width:220px">Aktion</th>
          </tr>
        </thead>
        <tbody id="adminTableBody">
          <tr><td colspan="6" class="muted" style="padding:14px 12px">Lade‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<div id="toast" role="status" aria-live="polite"></div>

<!-- Netlify Identity Widget -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<script>
/* =========================
   Endpunkte (Functions-Pfad)
   ========================= */
const API_LIST   = (status) => `/.netlify/functions/entries-list?status=${encodeURIComponent(status)}&t=${Date.now()}`;
const API_UPDATE = (id)     => `/.netlify/functions/entries-update?id=${encodeURIComponent(id)}&t=${Date.now()}`;

/* =============
   UI-Helferlein
   ============= */
function toast(msg, color = '#2d7a3e') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.style.background = color;
  el.style.opacity = '1';
  el.style.transform = 'translateY(0)';
  clearTimeout(el._t);
  el._t = setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(8px)'; }, 3500);
}
function $(s, r=document){ return r.querySelector(s); }

/* =========================
   Netlify Identity / Token
   ========================= */
async function getAuthHeader() {
  const id = window.netlifyIdentity;
  if (!id) return null;
  const user = id.currentUser();
  if (!user) return null;
  try { return { 'Authorization': `Bearer ${await user.jwt()}` }; }
  catch { return null; }
}
function setEmailUI() {
  const email = window.netlifyIdentity?.currentUser()?.email || '';
  $('[data-admin-email]').textContent = email;
}

/* =======================================
   Rendering der Tabellenzeilen
   ======================================= */
function renderRows(items) {
  const body = $('#adminTableBody');
  body.innerHTML = '';
  if (!items?.length) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" style="padding:12px;color:#a33">${window._lastErrorMsg || 'Keine Eintr√§ge.'}</td>`;
    window._lastErrorMsg = '';
    body.appendChild(tr);
    return;
  }
  for (const it of items) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.thumbUrl ? `<img src="${it.thumbUrl}" alt="" style="width:64px;height:40px;object-fit:cover;border-radius:6px">` : ''}</td>
      <td><strong>${it.name || ''}</strong><br><span class="muted">${it.address || ''}</span></td>
      <td>${it.city || ''}</td>
      <td>${it.category || ''}</td>
      <td>${it.createdAt ? new Date(it.createdAt).toLocaleString('de-DE') : ''}</td>
      <td style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" data-act="approve" data-id="${it.id}">Freigeben</button>
        <button class="btn" data-act="reject"  data-id="${it.id}">Ablehnen</button>
      </td>`;
    body.appendChild(tr);
  }
  body.onclick = (e) => {
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    updateEntry(btn.dataset.id, btn.dataset.act);
  };
}

/* =========================
   Laden (Pending/Approved)
   ========================= */
let currentTab = 'pending';
async function load(status = 'pending') {
  currentTab = status;
  try {
    const headers = { 'Accept': 'application/json' };
    // nur approved ist √∂ffentlich ‚Äì pending braucht Token
    if (status !== 'approved') {
      const auth = await getAuthHeader();
      if (auth) Object.assign(headers, auth);
    }
    const res = await fetch(API_LIST(status), { headers });
    if (!res.ok) {
      if (res.status === 401) {
        window._lastErrorMsg = '401: Nicht eingeloggt. Bitte ‚ÄûLogin‚Äú klicken.';
        toast(window._lastErrorMsg, '#c0392b');
      } else {
        window._lastErrorMsg = `Fehler: HTTP ${res.status}`;
        toast(window._lastErrorMsg, '#c0392b');
      }
      renderRows([]);
      return;
    }
    renderRows(await res.json());
  } catch (err) {
    console.error(err);
    window._lastErrorMsg = 'Netzwerkfehler beim Laden.';
    toast(window._lastErrorMsg, '#c0392b');
    renderRows([]);
  }
}

/* =========================
   Approve / Reject
   ========================= */
async function updateEntry(id, action) {
  try {
    const auth = await getAuthHeader();
    if (!auth) {
      toast('Nicht eingeloggt. Bitte ‚ÄûLogin‚Äú klicken.', '#c0392b');
      return;
    }
    const res = await fetch(API_UPDATE(id), {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json', ...auth },
      body: JSON.stringify({ action })
    });
    if (!res.ok) {
      if (res.status === 401) toast('Session abgelaufen. Bitte erneut einloggen.', '#c0392b');
      else toast(`Update fehlgeschlagen: ${res.status}`, '#c0392b');
      return;
    }
    toast(action === 'approve' ? 'Freigegeben ‚úÖ' : 'Abgelehnt ‚ùå');
    load(currentTab);
  } catch (err) {
    console.error(err);
    toast('Netzwerkfehler beim Aktualisieren.', '#c0392b');
  }
}

/* =========================
   UI ‚Äì Tabs, Login/Logout
   ========================= */
function wireUI(){
  $('#tabPending').onclick  = () => { setActiveTab('pending');  load('pending');  };
  $('#tabApproved').onclick = () => { setActiveTab('approved'); load('approved'); };
  $('#refreshBtn').onclick  = () => load(currentTab);

  $('#loginBtn').onclick  = () => { if (window.netlifyIdentity) netlifyIdentity.open('login'); };
  $('#logoutBtn').onclick = async () => { if (window.netlifyIdentity){ await netlifyIdentity.logout(); setEmailUI(); load(currentTab); } };

  if (window.netlifyIdentity) {
    netlifyIdentity.on('login',  () => { setEmailUI(); load(currentTab); netlifyIdentity.close(); });
    netlifyIdentity.on('logout', () => { setEmailUI(); load(currentTab); });
    netlifyIdentity.on('init',   () => { setEmailUI(); });
  }
  setActiveTab('pending');
}
function setActiveTab(tab){
  currentTab = tab;
  $('#tabPending').classList.toggle('active', tab==='pending');
  $('#tabApproved').classList.toggle('active', tab==='approved');
}

/* Start */
document.addEventListener('DOMContentLoaded', () => {
  wireUI();
  setEmailUI();
  load('pending');
});
</script>
</body>
</html>
