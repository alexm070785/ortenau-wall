// ---- Netlify Identity Login prüfen ----
if (typeof netlifyIdentity !== 'undefined') {
  netlifyIdentity.on('init', (user) => {
    console.log('Identity init:', user ? user.email : 'not logged in');
  });

  netlifyIdentity.on('login', (user) => {
    console.log('Logged in as', user.email);
  });

  netlifyIdentity.on('logout', () => {
    console.log('Logged out');
  });
}

// ---- Automatischer Fetch mit gültigem Token ----
async function authedFetch(url, opt = {}) {
  const u = netlifyIdentity.currentUser();
  const tok = u && (await u.jwt(true)); // ⚡ wichtig: true = refresh token
  return fetch(url, {
    ...opt,
    headers: {
      ...(opt.headers || {}),
      Authorization: tok ? `Bearer ${tok}` : '',
    },
  });
}

// ---- Beispiel: Pending-Einträge laden ----
async function loadPending() {
  const res = await authedFetch('/.netlify/functions/entries-list?status=pending');
  if (!res.ok) {
    console.error('Fehler beim Laden der Pending-Liste:', res.status);
    return;
  }
  const data = await res.json();
  console.log('Pending Entries:', data);
  // hier kannst du die Liste in dein HTML einsetzen
}

// ---- Beispiel: Eintrag genehmigen ----
async function approveEntry(id) {
  const res = await authedFetch(`/.netlify/functions/entries-update?id=${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'approve' }),
  });
  const data = await res.json();
  console.log('Approved:', data);
}

// ---- Beispiel: Ablehnen ----
async function rejectEntry(id) {
  const res = await authedFetch(`/.netlify/functions/entries-update?id=${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'reject' }),
  });
  const data = await res.json();
  console.log('Rejected:', data);
}
