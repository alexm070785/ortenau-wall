<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#f6f6f6">
<title>Admin ‚Äì Eintr√§ge & Werbung</title>

<style>
  :root{
    --bg:#f6f6f6; --card:#fff; --text:#222; --muted:#70798C;
    --radius:10px; --border:#d0d0d0; --shadow:0 3px 10px rgba(0,0,0,.07);
    --tap:42px; --accent:#222; --accent-weak:#efefef; --danger:#8b0000;
    --ring:#1e90ff33; --ring-strong:#1e90ff66;
  }

  *{box-sizing:border-box}
  html{font-size:15px}               /* minimal kleiner */
  @media (max-width:480px){ html{font-size:16px} }
  body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
    padding:14px                         /* leicht kompakter */
  }
  h1{margin:2px 0 14px;font-size:1.55rem;letter-spacing:.2px}

  .wrap{max-width:980px;margin:auto}

  .card{
    background:var(--card);border:1px solid var(--border);
    border-radius:var(--radius);box-shadow:var(--shadow);
    padding:14px                         /* kompakter */
  }

  .grid{display:grid;gap:10px}          /* dichter */
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:760px){ .g2,.g3{grid-template-columns:1fr} }

  label{font-weight:600;display:block;margin:4px 0}
  input,select,textarea{
    width:100%;padding:9px 11px;        /* kleiner innen */
    border:1px solid var(--border);border-radius:10px;
    background:#fff;font-size:.98rem;min-height:38px; /* niedriger */
    transition:border-color .15s, box-shadow .15s, background .15s;
  }
  input:focus,select:focus,textarea:focus{
    outline:none;border-color:#9ac7ff; box-shadow:0 0 0 3px var(--ring);
  }
  textarea{min-height:92px;resize:vertical}

  .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media (max-width:760px){ .row{grid-template-columns:1fr} }

  .muted{color:var(--muted);font-size:.93rem}

  /* Actions / Buttons ‚Äì kompakter & h√ºbsch */
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  button{
    border:0;border-radius:12px;padding:10px 14px;cursor:pointer;
    background:var(--accent);color:#fff;min-height:var(--tap);
    font-weight:600; letter-spacing:.2px; font-size:.98rem;
    box-shadow:0 2px 8px rgba(0,0,0,.08);
    transition:transform .08s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease;
  }
  button:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.12) }
  button:active{ transform:translateY(0); box-shadow:0 2px 8px rgba(0,0,0,.08) }
  button:focus-visible{ outline:none; box-shadow:0 0 0 3px var(--ring-strong) }
  button.secondary{
    background:var(--accent-weak); color:#222; border:1px solid var(--border);
  }
  button.secondary:hover{ background:#f6f6f6 }
  button.danger{background:var(--danger)}
  button.danger:hover{opacity:.92}

  /* Suchleiste/Toolbar */
  .bar{display:flex;gap:10px;align-items:center;margin:12px 0;flex-wrap:wrap}
  .bar input{max-width:240px;min-height:var(--tap)}

  /* Tabelle ‚Äì dichter + Row-Hover */
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:8px 10px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa;font-size:.95rem}
  tr:hover td{background:#fafafa}
  .right{text-align:right}
  .pill{display:inline-block;padding:3px 9px;border-radius:999px;border:1px solid #ddd;font-size:.88rem;background:#fafafa}

  /* Men√º-Vorschau */
  .menu-wrap{grid-column:1/-1}
  .menu-editor{font-family:var(--mono);min-height:220px}  /* etwas kleiner */
  .menu-meta{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px;flex-wrap:wrap}
  .menu-preview{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:10px;margin-top:8px;white-space:pre-wrap;line-height:1.5}
  .menu-preview .price{opacity:.9}

  /* Tabs ‚Äì schickere Optik */
  .tabs{display:flex;gap:6px;margin:0 0 10px}
  .tab{
    border:1px solid var(--border);background:#fff;border-radius:999px;
    padding:8px 12px;cursor:pointer;min-height:36px;font-weight:700;font-size:.95rem;
    transition:background .15s, color .15s, border-color .15s, box-shadow .15s;
  }
  .tab:hover{ background:#f5f5f5 }
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 2px 10px rgba(0,0,0,.12)}
  .hidden{display:none}

  /* Featured-Badge wie gehabt, minimal kompakter */
  tr.featured-row{background:linear-gradient(180deg,#fffef5,#fff8e1);box-shadow:0 0 10px rgba(212,175,55,.22)}
  tr.featured-row td{border-bottom:1px solid rgba(212,175,55,.25)}
  .featured-badge{
    display:inline-block;background:linear-gradient(90deg,#f6d777,#ffefb0);
    color:#5b4b1a;font-weight:600;border-radius:999px;padding:2px 8px;font-size:.82rem;margin-left:6px;box-shadow:0 2px 4px rgba(212,175,55,.2)
  }

  /* Kleine Buttons in Tabellen */
  .sm{ padding:7px 10px; border-radius:10px; min-height:unset; font-size:.92rem }

  /* Dezentere Scrollbar (nur WebKit) */
  ::-webkit-scrollbar{height:10px;width:10px}
  ::-webkit-scrollbar-thumb{background:#d7d7d7;border-radius:999px}
  ::-webkit-scrollbar-thumb:hover{background:#c9c9c9}
</style>

<div class="wrap">
  <h1>Admin</h1>

  <div class="tabs">
    <button class="tab active" data-tab="lokale">Lokale</button>
    <button class="tab" data-tab="ads">Werbung</button>
  </div>

  <!-- ============= TAB: LOKALE (unver√§ndert im Markup/JS) ============= -->
  <section id="tab-lokale">
    <div class="card grid g2" role="form">
      <div>
        <label for="titel">Name des Lokals *</label>
        <input id="titel" required placeholder="Genc D√∂ner & Pizza">
      </div>
      <div>
        <label for="kategorie">Kategorie *</label>
        <select id="kategorie">
          <option value="restaurant">Restaurant</option>
          <option value="pizzeria">Pizzeria</option>
          <option value="pizza">Pizza</option>
          <option value="d√∂ner">D√∂ner/Kebab</option>
          <option value="kebab">Kebab</option>
          <option value="cafe">Caf√©</option>
          <option value="imbiss">Imbiss</option>
          <option value="b√§ckerei">B√§ckerei</option>
        </select>
      </div>

      <div>
        <label for="strasse">Stra√üe & Nr.</label>
        <input id="strasse" placeholder="Hauptstr. 12">
      </div>
      <div class="row">
        <div>
          <label for="plz">PLZ</label>
          <input id="plz" placeholder="77652" inputmode="numeric">
        </div>
        <div>
          <label for="stadt">Ort / Stadt</label>
          <input id="stadt" placeholder="Offenburg">
        </div>
      </div>

      <div>
        <label for="telefon">Telefon</label>
        <input id="telefon" placeholder="+49 781 ‚Ä¶" inputmode="tel">
      </div>
      <div>
        <label for="email">E-Mail</label>
        <input id="email" type="email" placeholder="info@beispiel.de">
      </div>

      <div>
        <label for="website">Website</label>
        <input id="website" placeholder="https://‚Ä¶">
      </div>
      <div>
        <label for="speisekarte">Speisekarte-URL (optional)</label>
        <input id="speisekarte" placeholder="https://‚Ä¶/speisekarte.pdf">
      </div>

      <div>
        <label for="oeffnungszeiten">√ñffnungszeiten</label>
        <textarea id="oeffnungszeiten" placeholder="Mo‚ÄìFr 11‚Äì22; Sa 12‚Äì23; So geschlossen"></textarea>
      </div>
      <div>
        <label for="schliesstage">Schlie√ütage / Hinweise</label>
        <textarea id="schliesstage" placeholder="Feiertage geschlossen; Betriebsferien 1.‚Äì15. Aug."></textarea>
      </div>

      <div class="menu-wrap">
        <label for="menuText">Speisekarte ‚Äì Text (lang)</label>
        <textarea id="menuText" class="menu-editor" placeholder="Hier den kompletten Speisekarten-Text einf√ºgen ‚Ä¶"></textarea>
        <div class="menu-meta">
          <div class="muted">Zeilenumbr√ºche bleiben erhalten. Emojis wie ü•ô/ü•ó/üçï/ü•§ als √úberschriften m√∂glich.</div>
          <div class="muted"><span id="menuCount">0</span> Zeichen</div>
        </div>
        <div class="menu-preview" id="menuPreview" aria-live="polite">Vorschau erscheint hier ‚Ä¶</div>
      </div>

      <div>
        <label for="beschreibung">Kurzbeschreibung</label>
        <textarea id="beschreibung" placeholder="Hausgemachte Pasta & Steinofenpizza ‚Ä¶"></textarea>
      </div>
      <div>
        <label for="preisklasse">Preisniveau</label>
        <select id="preisklasse">
          <option value="">‚Äì</option>
          <option value="‚Ç¨">‚Ç¨ G√ºnstig</option>
          <option value="‚Ç¨‚Ç¨">‚Ç¨‚Ç¨ Mittel</option>
          <option value="‚Ç¨‚Ç¨‚Ç¨">‚Ç¨‚Ç¨‚Ç¨ H√∂her</option>
        </select>
      </div>

      <div>
        <label for="bild">Bild/Icon-URL</label>
        <input id="bild" placeholder="https://‚Ä¶/bild.jpg">
      </div>
      <div>
        <label for="url">Externe Seite (Detail/Bestellen)</label>
        <input id="url" placeholder="https://‚Ä¶">
      </div>

      <div class="g3" style="grid-column:1/-1;display:grid;gap:12px">
        <div>
          <label for="instagram">Instagram</label>
          <input id="instagram" placeholder="https://instagram.com/‚Ä¶">
        </div>
        <div>
          <label for="facebook">Facebook</label>
          <input id="facebook" placeholder="https://facebook.com/‚Ä¶">
        </div>
        <div>
          <label for="tiktok">TikTok</label>
          <input id="tiktok" placeholder="https://tiktok.com/@‚Ä¶">
        </div>
      </div>

      <div class="row" style="grid-column:1/-1">
        <label style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;font-weight:600">
          <span><input type="checkbox" id="abholung"> Abholung</span>
          <span><input type="checkbox" id="lieferung"> Lieferung</span>
          <span><input type="checkbox" id="featured"> Featured (Top)</span>
        </label>
        <div class="muted">Tipp: Nur wenige Eintr√§ge als ‚ÄûFeatured‚Äú markieren.</div>
      </div>

      <div style="grid-column:1/-1">
        <label for="token">Admin-Token (nur n√∂tig, wenn in Netlify gesetzt)</label>
        <input id="token" placeholder="optional ‚Äì NETLIFY_ADMIN_TOKEN">
        <div class="muted">Falls du in Netlify die Variable <b>NETLIFY_ADMIN_TOKEN</b> gesetzt hast, trage hier denselben Wert ein. Sonst leer lassen.</div>
      </div>

      <div class="actions" style="grid-column:1/-1">
        <button id="save">Speichern</button>
        <button id="fetch" class="secondary" type="button">Liste laden</button>
        <button id="exportBtn" class="secondary" type="button">Export (JSON)</button>
        <label class="secondary" style="padding:0;display:inline-flex;align-items:center;">
          <input id="importFile" type="file" accept=".json,.txt,.html,text/html,application/json" style="display:none">
          <span style="padding:12px 16px;display:inline-block;cursor:pointer">Import (JSON/HTML)</span>
        </label>
        <button id="clear" class="danger" type="button">ALLE l√∂schen</button>
      </div>
    </div>

    <div class="bar">
      <input id="filter" placeholder="Liste filtern ‚Ä¶">
      <span class="muted">Nur Anzeige ‚Äì Daten bleiben auf dem Server.</span>
    </div>

    <div class="card">
      <table>
        <thead><tr>
          <th>Titel</th><th>Kategorie</th><th>Ort</th><th>Telefon</th><th class="right">Links</th><th></th>
        </tr></thead>
        <tbody id="tbody"><tr><td colspan="6" class="muted">Noch nichts geladen.</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- ================= TAB: WERBUNG ================= -->
  <section id="tab-ads" class="hidden">
    <div class="card grid g2" role="form">
      <div>
        <label for="ad_title">Titel *</label>
        <input id="ad_title" placeholder="z. B. 2√ó1 Pizza-Deal" required>
      </div>
      <div>
        <label for="ad_active">Status</label>
        <select id="ad_active">
          <option value="true">Aktiv</option>
          <option value="false">Inaktiv</option>
        </select>
      </div>

      <div class="g2" style="grid-column:1/-1;display:grid;gap:12px">
        <div>
          <label for="ad_image">Bild-URL (1:1 oder 4:3)</label>
          <input id="ad_image" placeholder="https://‚Ä¶/banner.jpg">
        </div>
        <div>
          <label for="ad_url">Ziel-URL (Klick)</label>
          <input id="ad_url" placeholder="https://‚Ä¶">
        </div>
      </div>

      <div style="grid-column:1/-1">
        <label for="ad_text">Text / Beschreibung</label>
        <textarea id="ad_text" placeholder="Kurzer Werbetext ‚Ä¶" rows="3"></textarea>
      </div>

      <div class="row">
        <div>
          <label for="ad_start">Start (optional)</label>
          <input id="ad_start" type="date">
        </div>
        <div>
          <label for="ad_end">Ende (optional)</label>
          <input id="ad_end" type="date">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="ad_city">Targeting (Stadt, optional)</label>
          <input id="ad_city" placeholder="z. B. Offenburg">
        </div>
        <div>
          <label for="ad_weight">Priorit√§t</label>
          <input id="ad_weight" type="number" inputmode="numeric" placeholder="1 = hoch" value="1">
        </div>
      </div>

      <div style="grid-column:1/-1">
        <label for="ad_slot">Slot (Position)</label>
        <select id="ad_slot">
          <option value="home_right_mid">Startseite ¬∑ rechte Spalte (Mitte)</option>
          <option value="home_right_top">Startseite ¬∑ rechte Spalte (Oben)</option>
          <option value="home_right_bottom">Startseite ¬∑ rechte Spalte (Unten)</option>
        </select>
        <div class="muted">Du wolltest die Anzeige **rechts in der mittleren Spalte** ‚Äì das ist der Slot ‚Äûhome_right_mid‚Äú.</div>
      </div>

      <div class="actions" style="grid-column:1/-1">
        <button id="ad_save">Speichern</button>
        <button id="ad_fetch" class="secondary" type="button">Liste laden</button>
        <button id="ad_export" class="secondary" type="button">Export (JSON)</button>
        <label class="secondary" style="padding:0;display:inline-flex;align-items:center;">
          <input id="ad_importFile" type="file" accept="application/json" style="display:none">
          <span style="padding:12px 16px;display:inline-block;cursor:pointer">Import (JSON)</span>
        </label>
        <button id="ad_clear" class="danger" type="button">ALLE l√∂schen</button>
      </div>
    </div>

    <div class="bar">
      <input id="ad_filter" placeholder="Anzeigen filtern ‚Ä¶">
      <span class="muted">Nur Anzeige ‚Äì Daten bleiben auf dem Server.</span>
    </div>

    <div class="card">
      <table>
        <thead><tr>
          <th>Titel</th><th>Slot</th><th>Zeitraum</th><th>Aktiv</th><th class="right">Ziel</th><th></th>
        </tr></thead>
        <tbody id="ad_tbody"><tr><td colspan="6" class="muted">Noch nichts geladen.</td></tr></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ===== Tabs ===== */
const tabBtns = document.querySelectorAll('.tab');
const tabLokale = document.getElementById('tab-lokale');
const tabAds = document.getElementById('tab-ads');
function activate(which){
  tabBtns.forEach(b=>b.classList.toggle('active', b.dataset.tab===which));
  tabLokale.classList.toggle('hidden', which!=='lokale');
  tabAds.classList.toggle('hidden', which!=='ads');
}
tabBtns.forEach(b=>b.addEventListener('click', ()=>activate(b.dataset.tab)));
activate('lokale');

/* ===== Gemeinsames ===== */
const API = "/api/entries";
const ADS_API = "/api/ads";
const $ = s => document.querySelector(s);
let editingId = null;
let adEditingId = null;

/* ===== Men√º-Vorschau (Lokale) ===== */
function renderMenuPreview(txt){
  const box = $("#menuPreview");
  if(!txt.trim()){ box.textContent = "Vorschau erscheint hier ‚Ä¶"; return; }
  const lines = txt.replace(/\r\n/g,"\n").split("\n");
  const parts = [];
  const esc = s => s.replace(/[&<>\"']/g, m => ({"&":"&amp;","<":"&lt;","<": "&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  for(let i=0;i<lines.length;i++){
    const l = lines[i].trim();
    if(!l){ parts.push("<br>"); continue; }
    const next = lines[i+1]?.trim() || "";
    const looksPrice = /‚Ç¨|\d,\d{2}/.test(next);
    if(!/‚Ç¨|\d,\d{2}/.test(l) && looksPrice){
      parts.push(`<p>${esc(l)}<br><span class="price">${esc(next)}</span></p>`); i++; continue;
    }
    parts.push(`<p>${esc(l)}</p>`);
  }
  box.innerHTML = parts.join("\n");
}
const menuTA = $("#menuText"), menuCount = $("#menuCount");
function autoResize(){ menuTA.style.height="auto"; menuTA.style.height=(menuTA.scrollHeight+4)+"px"; }
function updateMenuUI(){ menuCount.textContent = menuTA.value.length; autoResize(); renderMenuPreview(menuTA.value); }
menuTA.addEventListener("input", updateMenuUI); updateMenuUI();

function hdrs(){
  const h = {"Content-Type":"application/json"};
  const t = $("#token").value.trim();
  if(t) h["x-admin-token"]=t;
  return h;
}

/* ===== Lokale ‚Äì Payload/CRUD (unver√§ndert) ===== */
function toPayload(){
  const titel = $("#titel").value.trim();
  const stadt = $("#stadt").value.trim();
  const kategorie = $("#kategorie").value;
  return {
    id: editingId || undefined,
    titel, stadt, kategorie,
    url: $("#url").value.trim(),
    adresse: { strasse: $("#strasse").value.trim(), plz: $("#plz").value.trim(), stadt },
    kontakt: { telefon: $("#telefon").value.trim(), email: $("#email").value.trim() },
    web: {
      website: $("#website").value.trim(), speisekarte: $("#speisekarte").value.trim(),
      instagram: $("#instagram").value.trim(), facebook: $("#facebook").value.trim(), tiktok: $("#tiktok").value.trim()
    },
    info: {
      oeffnungszeiten: $("#oeffnungszeiten").value.trim(),
      schliesstage: $("#schliesstage").value.trim(),
      beschreibung: $("#beschreibung").value.trim(),
      preisklasse: $("#preisklasse").value
    },
    optionen: { abholung: $("#abholung").checked, lieferung: $("#lieferung").checked, featured: $("#featured").checked },
    bild: $("#bild").value.trim(),
    menu: { text: $("#menuText").value }
  };
}

async function loadList(){
  const r = await fetch(API,{cache:"no-store"});
  const data = await r.json().catch(()=>[]);
  renderTable(Array.isArray(data)?data:[]);
}
function renderTable(items){
  const tb = $("#tbody");
  tb.innerHTML='';
  if(!items.length){ tb.innerHTML='<tr><td colspan="6" class="muted">Keine Eintr√§ge gespeichert.</td></tr>'; return; }
  const q = $("#filter").value.trim().toLowerCase();
  items
    .filter(i => !q || JSON.stringify(i).toLowerCase().includes(q))
    .forEach(i=>{
      const tr = document.createElement('tr');
      if (i.optionen?.featured) tr.classList.add('featured-row');
      const ort = i.stadt || i?.adresse?.stadt || '';
      const tel = i?.kontakt?.telefon || '';
      tr.innerHTML = `
        <td>${i.titel || ''}${i.optionen?.featured ? ' <span class="featured-badge">‚òÖ Featured</span>' : ''}</td>
        <td><span class="pill">${(i.kategorie||'').replace(/doener|d√∂ner|kebab/i,'D√∂ner/Kebab')}</span></td>
        <td>${ort}</td>
        <td>${tel}</td>
        <td class="right">
          ${i.url ? `<a href="${i.url}" target="_blank" rel="noopener">Seite</a>` : ''}
          ${i.web?.website ? ` ¬∑ <a href="${i.web.website}" target="_blank" rel="noopener">Website</a>` : ''}
          ${i.web?.speisekarte ? ` ¬∑ <a href="${i.web.speisekarte}" target="_blank" rel="noopener">Speisekarte</a>` : ''}
        </td>
        <td class="right">
          <button data-id="${i.id||''}" class="editBtn secondary sm">Bearbeiten</button>
          <button data-id="${i.id||''}" class="delBtn danger sm" style="margin-left:6px">L√∂schen</button>
        </td>`;
      tb.appendChild(tr);
    });

  tb.querySelectorAll('.editBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id'); if(!id){ alert('Dieser Eintrag hat noch keine ID ‚Äì bitte neu anlegen.'); return; }
      const r = await fetch(API,{cache:"no-store"}); const data = await r.json().catch(()=>[]);
      const item = (Array.isArray(data)?data:[]).find(x=>x.id===id);
      if(!item){ alert('Eintrag nicht gefunden.'); return; }
      editingId = id;
      $("#titel").value = item.titel||"";
      $("#kategorie").value = item.kategorie||"restaurant";
      $("#strasse").value = item.adresse?.strasse||"";
      $("#plz").value = item.adresse?.plz||"";
      $("#stadt").value = item.stadt || item.adresse?.stadt || "";
      $("#telefon").value = item.kontakt?.telefon||"";
      $("#email").value = item.kontakt?.email||"";
      $("#website").value = item.web?.website||"";
      $("#speisekarte").value = item.web?.speisekarte||"";
      $("#oeffnungszeiten").value = item.info?.oeffnungszeiten||"";
      $("#schliesstage").value = item.info?.schliesstage||"";
      $("#beschreibung").value = item.info?.beschreibung||"";
      $("#preisklasse").value = item.info?.preisklasse||"";
      $("#bild").value = item.bild||"";
      $("#url").value = item.url||"";
      $("#instagram").value = item.web?.instagram||"";
      $("#facebook").value = item.web?.facebook||"";
      $("#tiktok").value = item.web?.tiktok||"";
      $("#abholung").checked = !!item.optionen?.abholung;
      $("#lieferung").checked = !!item.optionen?.lieferung;
      $("#featured").checked = !!item.optionen?.featured;
      $("#menuText").value = item.menu?.text || "";
      updateMenuUI();
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
  tb.querySelectorAll('.delBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id'); if(!id) return;
      if(!confirm('Diesen Eintrag wirklich l√∂schen?')) return;
      const res = await fetch(`${API}?id=${encodeURIComponent(id)}`, { method:"DELETE", headers:hdrs() })
                        .then(r=>r.json()).catch(()=>({error:"Request failed"}));
      if(res && res.error){ alert('Fehler: ' + res.error); return; }
      loadList();
    });
  });
}
$("#save").onclick = async (e)=>{
  e.preventDefault();
  const p = toPayload();
  if(!p.titel){ alert('Bitte einen Namen eingeben.'); return; }
  const method = editingId ? "PUT" : "POST";
  const res = await fetch(API, { method, headers:hdrs(), body:JSON.stringify(p) })
                    .then(r=>r.json()).catch(()=>({error:"Request failed"}));
  if(res && res.error){ alert('Fehler: ' + res.error + '\n\nHinweis: Wenn NETLIFY_ADMIN_TOKEN gesetzt ist, trage es oben in das Token-Feld ein.'); return; }
  alert(editingId ? 'Aktualisiert!' : 'Gespeichert!');
  editingId = null; loadList();
};
$("#fetch").onclick = loadList;
$("#clear").onclick = async ()=>{
  if(!confirm('WIRKLICH alle Eintr√§ge l√∂schen?')) return;
  const res = await fetch(API, { method:"DELETE", headers:hdrs() })
                    .then(r=>r.json()).catch(()=>({error:"Request failed"}));
  if(res && res.error){ alert('Fehler: ' + res.error); return; }
  alert('Alles gel√∂scht.'); loadList();
};
$("#filter").addEventListener('input', loadList);
$("#exportBtn").onclick = async ()=>{
  const r = await fetch(API,{cache:"no-store"}); const data = await r.json().catch(()=>[]);
  const blob = new Blob([JSON.stringify(Array.isArray(data)?data:[],null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'eintraege.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
/* robuster Import (HTML/JSON) */
function tryJson(t){ try{ return JSON.parse(t); } catch{ return null; } }
function extractArrayFromHtml(htmlText){ const m = htmlText.match(/\[[\s\S]*\]/); return m ? tryJson(m[0]) : null; }
$("#importFile").onchange = async (ev)=>{
  const file = ev.target.files[0]; if(!file) return;
  let text = (await file.text()).replace(/^\uFEFF/,'').trim();
  let data = tryJson(text); if(!data && /^</.test(text)) data = extractArrayFromHtml(text);
  if(!Array.isArray(data)){ const obj = tryJson(text); if(obj){
    if(Array.isArray(obj)) data=obj; else if(Array.isArray(obj.entries)) data=obj.entries;
    else if(Array.isArray(obj.items)) data=obj.items; else if(Array.isArray(obj.data)) data=obj.data;
    else if(typeof obj.value==="string") data=tryJson(obj.value); else if(typeof obj.data==="string") data=tryJson(obj.data);
  }}
  if(!Array.isArray(data)){ alert("Ung√ºltiges JSON.\nErwartet wird eine JSON-Liste (Array) mit Eintr√§gen."); return; }
  if(!confirm(`Es werden ${data.length} Eintr√§ge importiert/aktualisiert. Fortfahren?`)) return;
  let ok=0,fail=0;
  for(const it of data){ const method = it && it.id ? "PUT" : "POST"; try{ await fetch(API,{method,headers:hdrs(),body:JSON.stringify(it)}); ok++; }catch{ fail++; } }
  alert(`Import abgeschlossen.\nErfolgreich: ${ok}${fail?`  Fehler: ${fail}`:''}`); loadList();
};
loadList();

/* ===== Werbung ‚Äì Payload/CRUD (nur "link" ge√§ndert) ===== */
function adPayload(){
  return {
    id: adEditingId || undefined,
    title: $("#ad_title").value.trim(),
    text: $("#ad_text").value.trim(),
    image: $("#ad_image").value.trim(),
    link: $("#ad_url").value.trim(),
    slot: $("#ad_slot").value,
    active: $("#ad_active").value === "true",
    start: $("#ad_start").value || null,
    end: $("#ad_end").value || null,
    city: $("#ad_city").value.trim() || null,
    weight: Number($("#ad_weight").value||1) || 1
  };
}
async function adsLoad(){
  const r = await fetch(ADS_API,{cache:"no-store"});
  const data = await r.json().catch(()=>[]);
  renderAds(Array.isArray(data)?data:[]);
}
function renderAds(items){
  const tb = $("#ad_tbody");
  tb.innerHTML='';
  if(!items.length){ tb.innerHTML='<tr><td colspan="6" class="muted">Keine Anzeigen gespeichert.</td></tr>'; return; }
  const q = $("#ad_filter").value.trim().toLowerCase();
  items
    .filter(a => !q || JSON.stringify(a).toLowerCase().includes(q))
    .sort((a,b)=> (b.active?-1:1) - (a.active?-1:1) || (a.weight||0) - (b.weight||0))
    .forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.title||''}</td>
        <td><span class="pill">${a.slot||''}</span></td>
        <td>${a.start||'‚Äì'} ‚Üí ${a.end||'‚Äì'}</td>
        <td>${a.active ? '‚úÖ' : '‚õîÔ∏è'}</td>
        <td class="right">${a.link ? `<a href="${a.link}" target="_blank" rel="noopener">Ziel</a>` : ''}</td>
        <td class="right">
          <button data-id="${a.id||''}" class="ad_edit secondary sm">Bearbeiten</button>
          <button data-id="${a.id||''}" class="ad_del danger sm" style="margin-left:6px">L√∂schen</button>
        </td>`;
      tb.appendChild(tr);
    });

  tb.querySelectorAll('.ad_edit').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id'); if(!id) return;
      const r = await fetch(ADS_API,{cache:"no-store"}); const data = await r.json().catch(()=>[]);
      const ad = (Array.isArray(data)?data:[]).find(x=>x.id===id); if(!ad){ alert('Anzeige nicht gefunden.'); return; }
      adEditingId = id;
      $("#ad_title").value = ad.title||"";
      $("#ad_text").value = ad.text||"";
      $("#ad_image").value = ad.image||"";
      $("#ad_url").value = ad.link || ad.url || "";
      $("#ad_slot").value = ad.slot||"home_right_mid";
      $("#ad_active").value = ad.active ? "true":"false";
      $("#ad_start").value = ad.start||"";
      $("#ad_end").value = ad.end||"";
      $("#ad_city").value = ad.city||"";
      $("#ad_weight").value = ad.weight||1;
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });
  tb.querySelectorAll('.ad_del').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id'); if(!id) return;
      if(!confirm('Diese Anzeige wirklich l√∂schen?')) return;
      const res = await fetch(`${ADS_API}?id=${encodeURIComponent(id)}`, { method:"DELETE", headers:hdrs() })
                        .then(r=>r.json()).catch(()=>({error:"Request failed"}));
      if(res && res.error){ alert('Fehler: ' + res.error); return; }
      adsLoad();
    });
  });
}
$("#ad_save").onclick = async ()=>{
  const p = adPayload();
  if(!p.title){ alert("Titel eingeben."); return; }
  const method = adEditingId ? "PUT":"POST";
  const res = await fetch(ADS_API, { method, headers:hdrs(), body:JSON.stringify(p) })
                    .then(r=>r.json()).catch(()=>({error:"Request failed"}));
  if(res && res.error){ alert('Fehler: ' + res.error); return; }
  alert(adEditingId ? 'Anzeige aktualisiert!' : 'Anzeige gespeichert!');
  adEditingId = null; adsLoad();
};
$("#ad_fetch").onclick = adsLoad;
$("#ad_clear").onclick = async ()=>{
  if(!confirm('WIRKLICH alle Anzeigen l√∂schen?')) return;
  const res = await fetch(ADS_API, { method:"DELETE", headers:hdrs() })
                    .then(r=>r.json()).catch(()=>({error:"Request failed"}));
  if(res && res.error){ alert('Fehler: ' + res.error); return; }
  alert('Alle Anzeigen gel√∂scht.'); adsLoad();
};
$("#ad_filter").addEventListener('input', adsLoad);
$("#ad_export").onclick = async ()=>{
  const r = await fetch(ADS_API,{cache:"no-store"}); const data = await r.json().catch(()=>[]);
  const blob = new Blob([JSON.stringify(Array.isArray(data)?data:[],null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'anzeigen.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$("#ad_importFile").onchange = async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  let data; try{ data = JSON.parse(await f.text()); }catch{ alert('Ung√ºltiges JSON.'); return; }
  if(!Array.isArray(data)){ alert('Erwarte ein Array von Anzeigen.'); return; }
  if(!confirm(`Es werden ${data.length} Anzeigen importiert/aktualisiert. Fortfahren?`)) return;
  let ok=0,fail=0; for(const ad of data){ const m = ad && ad.id ? "PUT":"POST"; try{ await fetch(ADS_API,{method:m,headers:hdrs(),body:JSON.stringify(ad)}); ok++; }catch{ fail++; } }
  alert(`Import abgeschlossen.\nErfolgreich: ${ok}${fail?`  Fehler: ${fail}`:''}`); adsLoad();
};

/* Beim ersten Aufruf Tab-spezifische Listen laden */
adsLoad();
</script>
