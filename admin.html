<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ortenau-Wall ¬∑ Admin</title>
  <style>
    :root{
      --accent:#e7e7e7; --text:#4f4f4f; --bg:#f6f6f6; --card:#fff;
      --muted:#70798C; --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.08);
      --shadowHover:0 6px 18px rgba(0,0,0,.12); --ok:#2d7a3e; --err:#c0392b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);}
    header{position:sticky;top:0;z-index:5;background:var(--accent);border-bottom:1px solid #b0b0b0}
    .head{max-width:1200px;margin:0 auto;padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between;}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #d0d0d0;background:#fff;cursor:pointer;box-shadow:var(--shadow)}
    .btn:hover{box-shadow:var(--shadowHover)}
    .btn.primary{background:#4f4f4f;color:#fff;border-color:#4f4f4f}
    .seg{display:inline-flex;border:1px solid #d0d0d0;border-radius:10px;overflow:hidden}
    .seg button{border:0;padding:8px 12px;background:#fff}
    .seg button.active{background:#eee;font-weight:600}
    main{max-width:1200px;margin:16px auto;padding:0 12px}
    .card{background:#fff;border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa}
    .muted{color:var(--muted)}
    .toast{position:fixed;right:16px;bottom:16px;min-width:240px;padding:10px 12px;border-radius:10px;color:#fff;background:#333;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .actions .btn{margin-right:6px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef;border:1px solid #dde;font-size:.85rem}
  </style>

  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<header>
  <div class="head">
    <div style="display:flex;gap:8px;align-items:center">
      <strong>Ortenau-Wall ¬∑ Admin</strong>
      <span id="who" class="chip muted">nicht eingeloggt</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="seg">
        <button id="btnPending" class="active">Pending</button>
        <button id="btnApproved">Approved</button>
      </div>
      <button id="btnReload" class="btn">üîÑ Aktualisieren</button>
      <button id="btnLogin"  class="btn">üîê Login</button>
      <button id="btnLogout" class="btn">üö™ Logout</button>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th style="width:92px">Bild</th>
          <th>Name & Adresse</th>
          <th>Ort</th>
          <th>Kat.</th>
          <th>Eingereicht</th>
          <th style="width:220px">Aktion</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="6" class="muted">Lade‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  // ---------- UI helpers ----------
  const $ = s => document.querySelector(s);
  const rows  = $('#rows');
  const toast = $('#toast');
  function showToast(msg, color){ toast.textContent = msg; toast.style.background = color || '#333';
    toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 3500); }

  // ---------- Netlify Identity ----------
  netlifyIdentity.init();
  const who = $('#who'), btnLogin = $('#btnLogin'), btnLogout = $('#btnLogout');

  function setUserInfo(u){
    if(u){ who.textContent = u.email || 'angemeldet'; who.classList.remove('muted'); }
    else { who.textContent = 'nicht eingeloggt'; who.classList.add('muted'); }
  }

  netlifyIdentity.on('init',  user => setUserInfo(user));
  netlifyIdentity.on('login', user => { setUserInfo(user); showToast('Eingeloggt', '#2d7a3e'); load(); });
  netlifyIdentity.on('logout',()  => { setUserInfo(null); showToast('Abgemeldet', '#666'); load(); });

  btnLogin.addEventListener('click', ()=> netlifyIdentity.open('login'));
  btnLogout.addEventListener('click',()=> netlifyIdentity.logout());

  async function getToken(){
    const u = netlifyIdentity.currentUser();
    if(!u) throw new Error('Nicht eingeloggt');
    return await u.jwt();
  }

  // ---------- API helper ----------
  async function api(path, {method='GET', body=null, auth=false}={}){
    const opt = { method, headers:{} };
    if(body && !(body instanceof FormData)){
      opt.headers['Content-Type'] = 'application/json';
      opt.body = JSON.stringify(body);
    }else if(body){ opt.body = body; }
    if(auth){
      try{
        const t = await getToken();
        opt.headers['Authorization'] = `Bearer ${t}`;
      }catch(e){
        // kein Token -> 401 erzeugen, damit UI reagiert
        const err = new Error('401'); err.status = 401; throw err;
      }
    }
    const res = await fetch(path, opt);
    let data = null;
    try{ data = await res.json(); }catch{}
    if(!res.ok){
      const err = new Error((data && (data.error||data.msg)) || ('HTTP '+res.status));
      err.status = res.status; throw err;
    }
    return data;
  }

  // ---------- Rendering ----------
  function render(list){
    rows.innerHTML = '';
    if(!list || !list.length){
      rows.innerHTML = '<tr><td colspan="6" class="muted">Keine Eintr√§ge.</td></tr>';
      return;
    }
    for(const it of list){
      const tr = document.createElement('tr');
      const img = (it.thumbUrl || it.images?.[0] || '').replace(/^\/+/, '/');
      const addr = it.address || '';
      tr.innerHTML = `
        <td>${ img ? `<img src="${img}" alt="" width="80" height="60" style="object-fit:cover;border-radius:6px">` : ''}</td>
        <td><strong>${it.name||''}</strong><br><span class="muted">${addr}</span></td>
        <td>${it.city||''}</td>
        <td><span class="chip">${it.category||it.cat||''}</span></td>
        <td><span class="muted">${(it.createdAt||'').replace('T',' ').replace('Z','')}</span></td>
        <td class="actions">
          <button class="btn primary"  data-act="approve" data-id="${it.id}">‚úÖ Freigeben</button>
          <button class="btn"           data-act="reject"  data-id="${it.id}">üóëÔ∏è Ablehnen</button>
          <button class="btn"           data-act="edit"    data-id="${it.id}">‚úèÔ∏è Bearbeiten</button>
        </td>`;
      rows.appendChild(tr);
    }
  }

  rows.addEventListener('click', async e=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const id = btn.dataset.id, act = btn.dataset.act;
    if(act === 'edit'){ showToast('Bearbeiten ist noch nicht implementiert'); return; }
    try{
      await api(`/entries-update?id=${encodeURIComponent(id)}`, {
        method:'PATCH',
        auth:true,
        body:{ action: act === 'approve' ? 'approve' : 'reject' }
      });
      showToast(act==='approve' ? 'Freigegeben' : 'Abgelehnt', '#2d7a3e');
      await load(); // neu laden
    }catch(err){
      if(err.status===401) showToast('401: Bitte einloggen (oder Seite neu laden).', '#c0392b');
      else showToast('Fehler: '+err.message, '#c0392b');
    }
  });

  // ---------- Status Umschalten / Laden ----------
  const btnPending  = $('#btnPending');
  const btnApproved = $('#btnApproved');
  const btnReload   = $('#btnReload');
  let currentStatus = 'pending';

  btnPending.addEventListener('click', ()=>{ currentStatus='pending';  setTabs(); load(); });
  btnApproved.addEventListener('click',()=>{ currentStatus='approved'; setTabs(); load(); });
  btnReload.addEventListener('click',   ()=> load());

  function setTabs(){
    btnPending.classList.toggle('active',  currentStatus==='pending');
    btnApproved.classList.toggle('active', currentStatus==='approved');
  }

  async function load(){
    rows.innerHTML = '<tr><td colspan="6" class="muted">Lade‚Ä¶</td></tr>';
    try{
      const list = await api(`/entries-list?status=${currentStatus}`, { auth: currentStatus!=='approved' });
      render(list);
    }catch(err){
      if(err.status===401){
        render([]);
        showToast('401: Nicht eingeloggt oder Session abgelaufen. Bitte ‚ÄûLogin‚Äú klicken.', '#c0392b');
      }else{
        render([]);
        showToast('Laden fehlgeschlagen: '+err.message, '#c0392b');
      }
    }
  }

  // Start
  setTabs();
  load();
</script>
</body>
</html>
