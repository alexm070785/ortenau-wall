<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#f6f6f6">
<title>Admin – Einträge & Werbung</title>
<style>
  :root{
    --bg:#f6f6f6; --card:#fff; --text:#222; --muted:#70798C; --radius:12px;
    --border:#d0d0d0; --shadow:0 4px 12px rgba(0,0,0,.08); --tap:48px;
    --mono: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
    --accent:#111827;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:16px}
  .wrap{max-width:1100px;margin:auto}
  h1{margin:4px 0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:760px){ .g2,.g3{grid-template-columns:1fr} }
  label{font-weight:600;display:block;margin:6px 0}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:1rem;min-height:44px}
  textarea{min-height:100px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:760px){ .row{grid-template-columns:1fr} }
  .muted{color:var(--muted);font-size:.95rem}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;background:#222;color:#fff;min-height:var(--tap)}
  button.secondary{background:#efefef;color:#222;border:1px solid var(--border)}
  button.danger{background:#8b0000}
  .bar{display:flex;gap:12px;align-items:center;margin:16px 0;flex-wrap:wrap}
  .bar input{max-width:260px;min-height:var(--tap)}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa}
  .right{text-align:right}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #ddd;font-size:.9rem;background:#fafafa}
  /* Tabs */
  .tabs{display:flex;gap:8px;margin:10px 0 16px;flex-wrap:wrap}
  .tab{padding:10px 14px;border:1px solid var(--border);background:#fafafa;border-radius:10px;cursor:pointer}
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .hidden{display:none}
  /* Speisekarte */
  .menu-wrap{grid-column:1/-1}
  .menu-editor{font-family:var(--mono);min-height:260px}
  .menu-meta{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:6px;flex-wrap:wrap}
  .menu-preview{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px;margin-top:10px;white-space:pre-wrap;line-height:1.5}
</style>

<div class="wrap">
  <h1>Admin</h1>

  <div class="tabs">
    <button class="tab active" data-tab="lokale">Lokale</button>
    <button class="tab" data-tab="ads">Werbung</button>
  </div>

  <!-- ========== TAB: LOKALE ========== -->
  <section id="tab-lokale">
    <!-- dein bestehendes Formular (gekürzt hier nicht) – ich übernehme deinen letzten Stand -->
    <!-- BEGIN: Formular Lokale (identisch mit deiner Version; nur hinten kommen Delete-Funktionen / keine Änderung nötig) -->

    <!-- ... (DEIN KOMPLETTES LOCALE-FORM HIER BELASSEN – das hast du schon) ... -->

    <div class="bar">
      <input id="filter" placeholder="Liste filtern …">
      <span class="muted">Nur Anzeige – Daten bleiben auf dem Server.</span>
    </div>

    <div class="card">
      <table>
        <thead><tr>
          <th>Titel</th><th>Kategorie</th><th>Ort</th><th>Telefon</th><th class="right">Links</th><th></th>
        </tr></thead>
        <tbody id="tbody"><tr><td colspan="6" class="muted">Noch nichts geladen.</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- ========== TAB: ADS ========== -->
  <section id="tab-ads" class="hidden">
    <div class="card grid g2">
      <div>
        <label for="adTitle">Titel *</label>
        <input id="adTitle" placeholder="z. B. Strom aus der Region">
      </div>
      <div>
        <label for="adCompany">Firma</label>
        <input id="adCompany" placeholder="z. B. Ortenau Energie GmbH">
      </div>

      <div>
        <label for="adCtaText">CTA-Text</label>
        <input id="adCtaText" placeholder="Jetzt informieren">
      </div>
      <div>
        <label for="adCtaUrl">CTA-URL *</label>
        <input id="adCtaUrl" placeholder="https://…">
      </div>

      <div>
        <label for="adLogo">Logo-URL</label>
        <input id="adLogo" placeholder="https://…/logo.png">
      </div>
      <div>
        <label for="adImage">Bild-URL</label>
        <input id="adImage" placeholder="https://…/banner.jpg">
      </div>

      <div>
        <label for="adStart">Start (inkl.)</label>
        <input id="adStart" type="date">
      </div>
      <div>
        <label for="adEnd">Ende (inkl.)</label>
        <input id="adEnd" type="date">
      </div>

      <div>
        <label for="adTarget">Zielgruppe (optional)</label>
        <input id="adTarget" placeholder="pizza,doener (Komma-getrennt)">
      </div>
      <div>
        <label for="adPriority">Priorität</label>
        <input id="adPriority" type="number" value="0">
      </div>

      <div class="g2" style="grid-column:1/-1">
        <div>
          <label for="adText">Text</label>
          <textarea id="adText" placeholder="Kurzer Teasertext …"></textarea>
        </div>
        <div>
          <label for="adBg">Hintergrund (CSS – optional)</label>
          <input id="adBg" placeholder="linear-gradient(90deg,#fff,#f7f7f7)">
          <div class="muted">Du kannst hier auch eine Farbe angeben, z. B. <code>#f7f7f7</code></div>
        </div>
      </div>

      <div style="grid-column:1/-1" class="actions">
        <button id="adSave">Werbung speichern</button>
        <button id="adNew" class="secondary" type="button">Neu</button>
        <button id="adDelete" class="danger" type="button">Diese Werbung löschen</button>
      </div>
    </div>

    <div class="bar">
      <input id="adFilter" placeholder="Werbeliste filtern …">
      <span class="muted">Aktiv = innerhalb Start/Ende.</span>
    </div>

    <div class="card">
      <table>
        <thead><tr>
          <th>Titel</th><th>Firma</th><th>Zeitraum</th><th>CTA</th><th></th>
        </tr></thead>
        <tbody id="adTbody"><tr><td colspan="5" class="muted">Keine Anzeigen.</td></tr></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* Tabs */
const $ = s => document.querySelector(s);
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.onclick = () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  document.querySelectorAll('section[id^="tab-"]').forEach(s => s.classList.add('hidden'));
  if (t.dataset.tab === 'lokale') $('#tab-lokale').classList.remove('hidden');
  if (t.dataset.tab === 'ads') $('#tab-ads').classList.remove('hidden');
});

/* ============ Lokale (dein bestehender Code) ============ */
const API = "/api/entries"; // unverändert
let editingId = null;

function hdrs(){
  const h = {"Content-Type":"application/json"};
  const t = document.getElementById("token")?.value?.trim();
  if(t) h["x-admin-token"]=t;
  return h;
}

async function loadList(){
  const r = await fetch(API);
  const data = await r.json();
  renderTable(data);
}

function renderTable(items){
  const tb = $("#tbody");
  tb.innerHTML='';
  if(!items.length){ tb.innerHTML='<tr><td colspan="6" class="muted">Keine Einträge gespeichert.</td></tr>'; return; }
  const q = $("#filter").value.trim().toLowerCase();
  items
    .filter(i => !q || JSON.stringify(i).toLowerCase().includes(q))
    .forEach(i=>{
      const tr = document.createElement('tr');
      const ort = i.stadt || i?.adresse?.stadt || '';
      const tel = i?.kontakt?.telefon || '';
      tr.innerHTML = `
        <td>${i.titel || ''}</td>
        <td><span class="pill">${(i.kategorie||'').replace(/doener|döner|kebab/i,'Döner/Kebab')}</span></td>
        <td>${ort}</td>
        <td>${tel}</td>
        <td class="right">
          ${i.url ? `<a href="${i.url}" target="_blank" rel="noopener">Seite</a>` : ''}
          ${i.web?.website ? ` · <a href="${i.web.website}" target="_blank" rel="noopener">Website</a>` : ''}
          ${i.web?.speisekarte ? ` · <a href="${i.web.speisekarte}" target="_blank" rel="noopener">Speisekarte</a>` : ''}
        </td>
        <td class="right">
          <button data-id="${i.id||''}" class="editBtn">Bearbeiten</button>
          <button data-id="${i.id||''}" class="delBtn danger">Löschen</button>
        </td>`;
      tb.appendChild(tr);
    });

  tb.querySelectorAll('.editBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id) return;
      const r = await fetch(API); const data = await r.json();
      const item = data.find(x=>x.id===id);
      if(!item) return;
      editingId = id;
      // (hier befüllst du deine Form-Felder – du hattest das schon; ich lasse es der Kürze halber weg)
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  // --- NEU: Delete Entry ---
  tb.querySelectorAll('.delBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id) return;
      if(!confirm('Eintrag wirklich löschen?')) return;
      const r = await fetch(API); const data = await r.json();
      const keep = data.filter(x=>x.id!==id);
      await fetch(API, { method:"DELETE", headers:hdrs(), body:JSON.stringify({}) }); // alles leeren
      // danach alle keep neu schreiben
      for (const it of keep) {
        await fetch(API, { method:"POST", headers:hdrs(), body:JSON.stringify(it) });
      }
      alert('Gelöscht.');
      loadList();
    });
  });
}

$("#filter")?.addEventListener('input', loadList);
loadList();

/* ============ Werbung (NEU) ============ */
const ADS = "/api/ads";
let adEditing = null;

function adHeaders(){ const h={"Content-Type":"application/json"}; const t=$("#token")?.value?.trim(); if(t) h["x-admin-token"]=t; return h; }

async function loadAds(){
  const r = await fetch(ADS); const arr = await r.json();
  renderAds(arr);
}
function fmtRange(a){
  const s = a.startDate||"", e = a.endDate||"";
  return (s||e) ? `${s||"?"} – ${e||"?"}` : "ohne Zeitraum";
}
function renderAds(list){
  const q = $("#adFilter").value.trim().toLowerCase();
  const tb = $("#adTbody"); tb.innerHTML="";
  if(list.length===0){ tb.innerHTML='<tr><td colspan="5" class="muted">Keine Anzeigen.</td></tr>'; return; }
  list
    .filter(x=>!q || JSON.stringify(x).toLowerCase().includes(q))
    .sort((a,b)=> (b.priority||0)-(a.priority||0))
    .forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.title||''}</td>
        <td>${a.company||''}</td>
        <td>${fmtRange(a)}</td>
        <td>${a.ctaText||'Mehr erfahren'}</td>
        <td class="right">
          <button class="adEdit" data-id="${a.id}">Bearbeiten</button>
          <button class="adDel danger" data-id="${a.id}">Löschen</button>
        </td>`;
      tb.appendChild(tr);
    });

  tb.querySelectorAll('.adEdit').forEach(b=>b.onclick = async ()=>{
    const id = b.dataset.id; const r = await fetch(ADS); const arr = await r.json();
    const a = arr.find(x=>x.id===id); if(!a) return;
    adEditing = id;
    $("#adTitle").value = a.title||"";
    $("#adCompany").value = a.company||"";
    $("#adCtaText").value = a.ctaText||"";
    $("#adCtaUrl").value = a.ctaUrl||"";
    $("#adLogo").value = a.logoUrl||"";
    $("#adImage").value = a.imageUrl||"";
    $("#adStart").value = a.startDate||"";
    $("#adEnd").value = a.endDate||"";
    $("#adTarget").value = a.target||"";
    $("#adPriority").value = a.priority||0;
    $("#adText").value = a.text||"";
    $("#adBg").value = a.bg||"";
    window.scrollTo({top:0,behavior:'smooth'});
    document.querySelector('.tab[data-tab="ads"]').click();
  });

  tb.querySelectorAll('.adDel').forEach(b=>b.onclick = async ()=>{
    const id = b.dataset.id; if(!confirm('Anzeige wirklich löschen?')) return;
    await fetch(ADS, { method:"DELETE", headers:adHeaders(), body:JSON.stringify({id}) });
    loadAds();
  });
}

$("#adSave").onclick = async ()=>{
  const p = {
    id: adEditing || undefined,
    title: $("#adTitle").value.trim(),
    company: $("#adCompany").value.trim(),
    ctaText: $("#adCtaText").value.trim() || "Mehr erfahren",
    ctaUrl: $("#adCtaUrl").value.trim(),
    logoUrl: $("#adLogo").value.trim(),
    imageUrl: $("#adImage").value.trim(),
    startDate: $("#adStart").value,
    endDate: $("#adEnd").value,
    target: $("#adTarget").value.trim(),
    priority: Number($("#adPriority").value||0),
    text: $("#adText").value,
    bg: $("#adBg").value.trim()
  };
  if(!p.title || !p.ctaUrl){ alert('Titel & CTA-URL sind Pflicht.'); return; }
  const method = adEditing ? "PUT":"POST";
  const r = await fetch(ADS, { method, headers:adHeaders(), body:JSON.stringify(p) }).then(r=>r.json());
  if(r.error){ alert('Fehler: '+r.error); return; }
  adEditing = null;
  ["adTitle","adCompany","adCtaText","adCtaUrl","adLogo","adImage","adStart","adEnd","adTarget","adPriority","adText","adBg"].forEach(id=>{ $("#"+id).value=""; });
  loadAds();
  alert('Gespeichert.');
};
$("#adNew").onclick = ()=>{ adEditing=null; ["adTitle","adCompany","adCtaText","adCtaUrl","adLogo","adImage","adStart","adEnd","adTarget","adPriority","adText","adBg"].forEach(id=>{ $("#"+id).value=""; }); };
$("#adDelete").onclick = async ()=>{
  if(!adEditing){ alert('Erst eine Anzeige via „Bearbeiten“ auswählen.'); return; }
  if(!confirm('Diese Anzeige löschen?')) return;
  await fetch(ADS, { method:"DELETE", headers:adHeaders(), body:JSON.stringify({id:adEditing}) });
  adEditing=null; loadAds();
};
$("#adFilter").addEventListener('input', loadAds);
loadAds();
</script>
