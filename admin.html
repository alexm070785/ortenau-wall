<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Admin ¬∑ Ortenau liefert</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#f6f7f9;color:#222}
  .top{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;z-index:5}
  .wrap{max-width:1100px;margin:0 auto;padding:12px 16px}
  h1{margin:0;font-size:18px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .btn{appearance:none;border:1px solid #d1d5db;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .btn.danger{color:#ef4444;border-color:#fecaca}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:14px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  .field{display:grid;gap:6px}
  .field input,.field select,.field textarea{padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font:inherit}
  .field textarea{min-height:100px;resize:vertical}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
  .thumb{width:64px;height:64px;object-fit:cover;border-radius:8px;border:1px solid #eee}
  .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transition:.2s;z-index:10}
  .toast.show{opacity:1}
</style>
</head>
<body>
<div class="top">
  <div class="wrap row">
    <h1>Admin ¬∑ Ortenau liefert</h1>
    <div class="row">
      <span id="who" class="pill">nicht eingeloggt</span>
      <button class="btn" id="btnLogin">üîê Login</button>
      <button class="btn" id="btnLogout">üö™ Logout</button>
    </div>
  </div>
</div>

<div class="wrap grid" style="margin-top:14px">
  <!-- Formular -->
  <div class="card">
    <h2 style="margin:0 0 10px">Neues Lokal anlegen</h2>
    <form id="f" enctype="multipart/form-data">
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
        <div class="field"><label>Name*</label><input name="name" required></div>
        <div class="field">
          <label>Kategorie*</label>
          <select name="category" required>
            <option value="">Bitte w√§hlen‚Ä¶</option>
            <option value="restaurant">Restaurant</option>
            <option value="pizzeria">Pizzeria</option>
            <option value="doener">D√∂ner</option>
          </select>
        </div>
        <div class="field"><label>Stadt*</label><input name="city" required></div>
        <div class="field"><label>PLZ*</label><input name="zip" required></div>
        <div class="field"><label>Stra√üe*</label><input name="street" required></div>
        <div class="field"><label>Telefon</label><input name="phone"></div>
        <div class="field"><label>Webseite</label><input name="website" placeholder="https://‚Ä¶"></div>
        <div class="field"><label>Google-Maps-URL</label><input name="mapsUrl" placeholder="https://maps.google.com/..."></div>
        <div class="field" style="grid-column:1/-1"><label>Men√º/Notiz</label><textarea name="menuText"></textarea></div>
        <div class="field"><label>Bild</label><input type="file" name="image" accept="image/*"></div>
        <div class="field"><label>Featured</label>
          <select name="featured">
            <option value="false" selected>Nein</option>
            <option value="true">Ja</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px;text-align:right">
        <button class="btn primary" type="submit">Speichern</button>
      </div>
    </form>
  </div>

  <!-- Liste -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0">Eintr√§ge</h2>
      <button class="btn" id="btnReload">üîÑ Neu laden</button>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>Bild</th><th>Name</th><th>Adresse</th><th>Kat.</th><th>Featured</th><th>Aktion</th>
        </tr></thead>
        <tbody id="rows"><tr><td colspan="6">Lade‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast">OK</div>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
const $ = (s, r=document)=>r.querySelector(s);
const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); };

function imgOf(it){
  if (it.imageUrl) return it.imageUrl;
  if (it.thumbUrl) return it.thumbUrl;
  return "icons/restaurant.png";
}

async function authedFetch(url, opt={}){
  const u = netlifyIdentity.currentUser();
  const tok = u && await u.jwt();
  const headers = { ...(opt.headers||{}) };
  if (tok) headers.Authorization = `Bearer ${tok}`;
  return fetch(url, { ...opt, headers });
}

// Login/Logout
(function(){
  const who = $('#who');
  function showUser(u){ who.textContent = u ? (u.user_metadata?.full_name || u.email) : "nicht eingeloggt"; }
  $('#btnLogin').addEventListener('click', ()=> netlifyIdentity.open('login'));
  $('#btnLogout').addEventListener('click', ()=> netlifyIdentity.logout());
  netlifyIdentity.on('init', u=>{ showUser(u); if(u) { load(); } });
  netlifyIdentity.on('login', u=>{ showUser(u); netlifyIdentity.close(); load(); });
  netlifyIdentity.on('logout', ()=>{ showUser(null); $('#rows').innerHTML = '<tr><td colspan="6">Bitte einloggen.</td></tr>'; });
  netlifyIdentity.init();
})();

// Formular submit -> entries-create
$('#f').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = e.target;
  if (!form.checkValidity()) return form.reportValidity();

  const fd = new FormData(form);
  try {
    const res = await authedFetch('/.netlify/functions/entries-create', { method:'POST', body: fd });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
    toast('Gespeichert');
    form.reset();
    load();
  } catch (err) {
    console.error(err);
    toast('Fehler beim Speichern');
  }
});

// Liste laden
async function load(){
  const tbody = $('#rows');
  tbody.innerHTML = '<tr><td colspan="6">Lade‚Ä¶</td></tr>';
  try{
    // als Admin alles sehen (status=all)
    const res = await authedFetch('/.netlify/functions/entries-list?status=all');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const items = await res.json();
    if(!items.length){ tbody.innerHTML = '<tr><td colspan="6">Keine Eintr√§ge.</td></tr>'; return; }
    tbody.innerHTML = '';
    items.forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><img class="thumb" src="${imgOf(it)}" alt=""></td>
        <td><b>${it.name||''}</b><div style="color:#6b7280;font-size:12px">${it.website||''}</div></td>
        <td>${[it.street, it.zip && it.city ? it.zip+' '+it.city : it.city].filter(Boolean).join(', ')}</td>
        <td>${it.category||''}</td>
        <td>${it.featured? 'Ja':'Nein'}</td>
        <td>
          <button class="btn" data-act="edit" data-id="${it.id}">‚úèÔ∏è</button>
          <button class="btn danger" data-act="del" data-id="${it.id}">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }catch(e){
    console.error(e);
    tbody.innerHTML = '<tr><td colspan="6">Fehler beim Laden.</td></tr>';
  }
}
$('#btnReload').addEventListener('click', load);

// Aktionen: edit (schnell), delete
$('#rows').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id;
  const act = btn.dataset.act;

  if (act === 'del') {
    if (!confirm('Diesen Eintrag wirklich l√∂schen?')) return;
    try{
      const res = await authedFetch(`/.netlify/functions/entries-update?id=${encodeURIComponent(id)}`, { method:'DELETE' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      toast('Gel√∂scht');
      load();
    }catch(err){ console.error(err); toast('L√∂schen fehlgeschlagen'); }
  }

  if (act === 'edit') {
    // Mini-Dialog per prompt (einfach & schnell)
    const name = prompt('Name neu (leer = unver√§ndert):');
    const payload = {};
    if (name !== null && name.trim()) payload.name = name.trim();

    const featured = prompt('Featured? (ja/nein, leer = unver√§ndert):');
    if (featured && /ja|nein/i.test(featured)) payload.featured = /^ja/i.test(featured);

    if (Object.keys(payload).length === 0) return;
    try{
      const res = await authedFetch(`/.netlify/functions/entries-update?id=${encodeURIComponent(id)}`, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      toast('Aktualisiert');
      load();
    }catch(err){ console.error(err); toast('Aktualisieren fehlgeschlagen'); }
  }
});
</script>
</body>
</html>
