<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#f6f6f6">
<title>Admin – Einträge & Werbung</title>
<style>
  :root{
    --bg:#f6f6f6; --card:#fff; --text:#222; --muted:#70798C; --radius:12px;
    --border:#d0d0d0; --shadow:0 4px 12px rgba(0,0,0,.08); --tap:48px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --danger:#8b0000; --primary:#111;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;padding:16px}
  h1{margin:6px 0 16px}
  .wrap{max-width:1000px;margin:auto}
  .tabs{display:flex;gap:8px;margin:8px 0 16px}
  .tab{border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;min-height:var(--tap)}
  .tab.active{background:#111;color:#fff;border-color:#111}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .g3{grid-template-columns:repeat(3,1fr)}
  @media (max-width:760px){ .g2,.g3{grid-template-columns:1fr} }
  label{font-weight:600;display:block;margin:6px 0}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;background:#fff;font-size:1rem;min-height:44px}
  textarea{min-height:100px;resize:vertical}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:760px){ .row{grid-template-columns:1fr} }
  .muted{color:var(--muted);font-size:.95rem}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  button{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;background:var(--primary);color:#fff;min-height:var(--tap)}
  button.secondary{background:#efefef;color:#222;border:1px solid var(--border)}
  button.danger{background:var(--danger)}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa}
  .right{text-align:right}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #ddd;font-size:.9rem;background:#fafafa}
  .toolbar{display:flex;gap:12px;align-items:center;margin:10px 0}
  .hidden{display:none}
  .note{background:#fffef3;border:1px solid #f1e3a5;border-radius:10px;padding:8px 12px;color:#6b5b00}
</style>

<div class="wrap">
  <h1>Admin</h1>

  <div class="tabs">
    <button class="tab active" data-tab="lokale">Lokale</button>
    <button class="tab" data-tab="werbung">Werbung</button>
  </div>

  <!-- TAB: LOKALE -->
  <section id="tab-lokale">
    <div class="card grid g2" role="form">
      <div>
        <label for="titel">Name des Lokals *</label>
        <input id="titel" required placeholder="Genc Döner & Pizza">
      </div>
      <div>
        <label for="kategorie">Kategorie *</label>
        <select id="kategorie">
          <option value="restaurant">Restaurant</option>
          <option value="pizzeria">Pizzeria</option>
          <option value="pizza">Pizza</option>
          <option value="döner">Döner/Kebab</option>
          <option value="kebab">Kebab</option>
          <option value="cafe">Café</option>
          <option value="imbiss">Imbiss</option>
          <option value="bäckerei">Bäckerei</option>
        </select>
      </div>

      <div>
        <label for="strasse">Straße & Nr.</label>
        <input id="strasse" placeholder="Hauptstr. 12">
      </div>
      <div class="row">
        <div>
          <label for="plz">PLZ</label>
          <input id="plz" placeholder="77652" inputmode="numeric">
        </div>
        <div>
          <label for="stadt">Ort / Stadt</label>
          <input id="stadt" placeholder="Offenburg">
        </div>
      </div>

      <div>
        <label for="telefon">Telefon</label>
        <input id="telefon" placeholder="+49 781 …" inputmode="tel">
      </div>
      <div>
        <label for="email">E-Mail</label>
        <input id="email" type="email" placeholder="info@beispiel.de">
      </div>

      <div>
        <label for="website">Website</label>
        <input id="website" placeholder="https://…">
      </div>
      <div>
        <label for="speisekarte">Speisekarte-URL (optional)</label>
        <input id="speisekarte" placeholder="https://…/speisekarte.pdf">
      </div>

      <div>
        <label for="oeffnungszeiten">Öffnungszeiten</label>
        <textarea id="oeffnungszeiten" placeholder="Mo–Fr 11–22; Sa 12–23; So geschlossen"></textarea>
      </div>
      <div>
        <label for="schliesstage">Schließtage / Hinweise</label>
        <textarea id="schliesstage" placeholder="Feiertage geschlossen; Betriebsferien …"></textarea>
      </div>

      <div style="grid-column:1/-1">
        <label for="beschreibung">Kurzbeschreibung</label>
        <textarea id="beschreibung" placeholder="Hausgemachte Spezialitäten …"></textarea>
      </div>

      <div>
        <label for="preisklasse">Preisniveau</label>
        <select id="preisklasse">
          <option value="">–</option>
          <option value="€">€ Günstig</option>
          <option value="€€">€€ Mittel</option>
          <option value="€€€">€€€ Höher</option>
        </select>
      </div>
      <div>
        <label for="bild">Bild/Icon-URL</label>
        <input id="bild" placeholder="https://…/bild.jpg">
      </div>

      <div>
        <label for="url">Externe Seite (Detail/Bestellen)</label>
        <input id="url" placeholder="https://…">
      </div>
      <div></div>

      <div class="g3" style="grid-column:1/-1;display:grid;gap:12px">
        <div>
          <label for="instagram">Instagram</label>
          <input id="instagram" placeholder="https://instagram.com/…">
        </div>
        <div>
          <label for="facebook">Facebook</label>
          <input id="facebook" placeholder="https://facebook.com/…">
        </div>
        <div>
          <label for="tiktok">TikTok</label>
          <input id="tiktok" placeholder="https://tiktok.com/@…">
        </div>
      </div>

      <div class="row" style="grid-column:1/-1">
        <label style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;font-weight:600">
          <span><input type="checkbox" id="abholung"> Abholung</span>
          <span><input type="checkbox" id="lieferung"> Lieferung</span>
          <span><input type="checkbox" id="featured"> Featured (Top)</span>
        </label>
        <div class="muted">Tipp: Nur wenige Einträge als „Featured“ markieren.</div>
      </div>

      <div style="grid-column:1/-1">
        <label for="token">Admin-Token (nur nötig, wenn in Netlify gesetzt)</label>
        <input id="token" placeholder="optional – NETLIFY_ADMIN_TOKEN">
        <div class="muted">Falls du in Netlify die Variable <b>NETLIFY_ADMIN_TOKEN</b> gesetzt hast, trage hier denselben Wert ein. Sonst leer lassen.</div>
      </div>

      <div class="actions" style="grid-column:1/-1">
        <button id="save">Speichern</button>
        <button id="fetch" class="secondary" type="button">Liste laden</button>
        <button id="exportBtn" class="secondary" type="button">Export (JSON)</button>
        <label class="secondary" style="padding:0;display:inline-flex;align-items:center;">
          <input id="importFile" type="file" accept="application/json" style="display:none">
          <span style="padding:12px 16px;display:inline-block;cursor:pointer">Import (JSON)</span>
        </label>
        <button id="clear" class="danger" type="button">ALLE löschen</button>
      </div>
    </div>

    <div class="toolbar">
      <input id="filter" placeholder="Liste filtern …" style="flex:1;min-height:var(--tap);border:1px solid var(--border);border-radius:12px;padding:0 12px;background:#fff">
      <span class="muted">Nur Anzeige – Daten bleiben auf dem Server.</span>
    </div>

    <div class="card">
      <table>
        <thead><tr>
          <th>Titel</th><th>Kategorie</th><th>Ort</th><th>Telefon</th><th class="right">Links</th><th></th>
        </tr></thead>
        <tbody id="tbody"><tr><td colspan="6" class="muted">Noch nichts geladen.</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- TAB: WERBUNG (Stub – dein Formular bleibt) -->
  <section id="tab-werbung" class="hidden">
    <div class="note" style="margin:8px 0 12px">
      Dies ist der Werbung-Tab. Dein bestehendes Formular bleibt – hier musst du nichts ändern.
      (Die Logik in deiner Function für Werbung bauen wir im nächsten Schritt.)
    </div>
    <div class="card">
      <p class="muted">Werbe-Formular – wie von dir bereits angelegt. (Kein Konflikt mit dem Lokale-Tab.)</p>
    </div>
  </section>
</div>

<script>
/* Tabs */
const tabBtns = document.querySelectorAll('.tab');
const tabLokale = document.getElementById('tab-lokale');
const tabAds = document.getElementById('tab-werbung');
function activate(which){
  tabBtns.forEach(b=>b.classList.toggle('active', b.dataset.tab===which));
  tabLokale.classList.toggle('hidden', which!=='lokale');
  tabAds.classList.toggle('hidden', which!=='werbung');
}
tabBtns.forEach(b=>b.addEventListener('click', ()=>activate(b.dataset.tab)));
activate('lokale');

/* ===== Lokale: API & Liste ===== */
const API = "/api/entries";
const $ = s => document.querySelector(s);
let editingId = null;

function hdrs(){
  const h = {"Content-Type":"application/json"};
  const t = $("#token").value.trim();
  if(t) h["x-admin-token"]=t;
  return h;
}
function toPayload(){
  const titel = $("#titel").value.trim();
  const stadt = $("#stadt").value.trim();
  const kategorie = $("#kategorie").value;
  return {
    id: editingId || undefined,
    titel, stadt, kategorie,
    url: $("#url").value.trim(),
    adresse: { strasse: $("#strasse").value.trim(), plz: $("#plz").value.trim(), stadt },
    kontakt: { telefon: $("#telefon").value.trim(), email: $("#email").value.trim() },
    web: {
      website: $("#website").value.trim(), speisekarte: $("#speisekarte").value.trim(),
      instagram: $("#instagram").value.trim(), facebook: $("#facebook").value.trim(), tiktok: $("#tiktok").value.trim()
    },
    info: {
      oeffnungszeiten: $("#oeffnungszeiten").value.trim(),
      schliesstage: $("#schliesstage").value.trim(),
      beschreibung: $("#beschreibung").value.trim(),
      preisklasse: $("#preisklasse").value
    },
    optionen: { abholung: $("#abholung").checked, lieferung: $("#lieferung").checked, featured: $("#featured").checked },
    bild: $("#bild").value.trim()
  };
}

async function loadList(){
  try{
    const r = await fetch(API,{cache:"no-store"});
    const data = await r.json();
    renderTable(Array.isArray(data)? data : []);
  }catch(e){
    console.error(e);
    renderTable([]);
  }
}
function renderTable(items){
  const tb = $("#tbody");
  tb.innerHTML='';
  if(!items.length){ tb.innerHTML='<tr><td colspan="6" class="muted">Keine Einträge gespeichert.</td></tr>'; return; }
  const q = $("#filter").value.trim().toLowerCase();
  items
    .filter(i => !q || JSON.stringify(i).toLowerCase().includes(q))
    .forEach(i=>{
      const tr = document.createElement('tr');
      const ort = i.stadt || i?.adresse?.stadt || '';
      const tel = i?.kontakt?.telefon || '';
      const cat = (i.kategorie||'').replace(/doener|döner|kebab/i,'Döner/Kebab');
      tr.innerHTML = `
        <td>${i.titel || ''}</td>
        <td><span class="pill">${cat}</span></td>
        <td>${ort}</td>
        <td>${tel}</td>
        <td class="right">
          ${i.url ? `<a href="${i.url}" target="_blank" rel="noopener">Seite</a>` : ''}
          ${i.web?.website ? ` · <a href="${i.web.website}" target="_blank" rel="noopener">Website</a>` : ''}
          ${i.web?.speisekarte ? ` · <a href="${i.web.speisekarte}" target="_blank" rel="noopener">Speisekarte</a>` : ''}
        </td>
        <td class="right">
          <button data-id="${i.id||''}" class="editBtn secondary">Bearbeiten</button>
          <button data-id="${i.id||''}" class="delBtn danger">Löschen</button>
        </td>`;
      tb.appendChild(tr);
    });

  tb.querySelectorAll('.editBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id){ alert('Dieser Eintrag hat noch keine ID – bitte neu anlegen.'); return; }
      const r = await fetch(API); const data = await r.json();
      const item = data.find(x=>x.id===id);
      if(!item){ alert('Eintrag nicht gefunden.'); return; }
      editingId = id;
      $("#titel").value = item.titel||"";
      $("#kategorie").value = item.kategorie||"restaurant";
      $("#strasse").value = item.adresse?.strasse||"";
      $("#plz").value = item.adresse?.plz||"";
      $("#stadt").value = item.stadt || item.adresse?.stadt || "";
      $("#telefon").value = item.kontakt?.telefon||"";
      $("#email").value = item.kontakt?.email||"";
      $("#website").value = item.web?.website||"";
      $("#speisekarte").value = item.web?.speisekarte||"";
      $("#oeffnungszeiten").value = item.info?.oeffnungszeiten||"";
      $("#schliesstage").value = item.info?.schliesstage||"";
      $("#beschreibung").value = item.info?.beschreibung||"";
      $("#preisklasse").value = item.info?.preisklasse||"";
      $("#bild").value = item.bild||"";
      $("#url").value = item.url||"";
      $("#instagram").value = item.web?.instagram||"";
      $("#facebook").value = item.web?.facebook||"";
      $("#tiktok").value = item.web?.tiktok||"";
      $("#abholung").checked = !!item.optionen?.abholung;
      $("#lieferung").checked = !!item.optionen?.lieferung;
      $("#featured").checked = !!item.optionen?.featured;
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  tb.querySelectorAll('.delBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-id');
      if(!id) return;
      if(!confirm('Diesen Eintrag wirklich löschen?')) return;
      // einfache Strategie: komplette Liste holen, filtern, zurückschreiben
      const r = await fetch(API); const data = await r.json();
      const list = (Array.isArray(data)?data:[]).filter(x=>x.id!==id);

      // Alles löschen:
      await fetch(API, { method:"DELETE", headers:hdrs() }).catch(()=>{});

      // Liste neu schreiben:
      for(const it of list){
        await fetch(API, { method: it.id ? "POST" : "POST", headers:hdrs(), body:JSON.stringify(it) });
      }
      loadList();
    });
  });
}

$("#save").onclick = async (e)=>{
  e.preventDefault();
  const p = toPayload();
  if(!p.titel){ alert('Bitte einen Namen eingeben.'); return; }
  const method = editingId ? "PUT" : "POST";
  try{
    const res = await fetch(API, { method, headers:hdrs(), body:JSON.stringify(p) });
    const json = await res.json();
    if(json.error){ alert('Fehler: ' + json.error + '\n\nHinweis: Wenn NETLIFY_ADMIN_TOKEN gesetzt ist, trage es oben in das Token-Feld ein.'); return; }
    alert(editingId ? 'Aktualisiert!' : 'Gespeichert!');
    editingId = null;
    loadList();
  }catch(err){ alert('Fehler beim Speichern'); }
};
$("#fetch").onclick = loadList;
$("#clear").onclick = async ()=>{
  if(!confirm('WIRKLICH alle Einträge löschen?')) return;
  const res = await fetch(API, { method:"DELETE", headers:hdrs() }).then(r=>r.json()).catch(()=>null);
  if(res && res.error){ alert('Fehler: ' + res.error); return; }
  alert('Alles gelöscht.'); loadList();
};
$("#filter").addEventListener('input', loadList);

$("#exportBtn").onclick = async ()=>{
  const r = await fetch(API,{cache:"no-store"}); const data = await r.json();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:'eintraege.json'});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};

/* >>> ROBUSTER IMPORT (BOM entfernen, Wrapper erkennen, PUT/POST korrekt) <<< */
$("#importFile").onchange = async (ev)=>{
  const file = ev.target.files[0];
  if(!file) return;

  let text = await file.text();
  let data = null;

  // 1) BOM entfernen + trimmen
  text = text.replace(/^\uFEFF/, '').trim();

  const tryParse = (t) => { try { return JSON.parse(t); } catch { return null; } };

  // 2) direkt versuchen
  data = tryParse(text);

  // 3) Wrapper-Varianten (Object mit entries/items/data oder value als String)
  if (!Array.isArray(data)) {
    const obj = tryParse(text);
    if (obj) {
      if (Array.isArray(obj)) {
        data = obj;
      } else if (Array.isArray(obj.entries)) {
        data = obj.entries;
      } else if (Array.isArray(obj.items)) {
        data = obj.items;
      } else if (Array.isArray(obj.data)) {
        data = obj.data;
      } else if (typeof obj.value === "string") {
        data = tryParse(obj.value);
      } else if (typeof obj.data === "string") {
        data = tryParse(obj.data);
      }
    }
  }

  // 4) Final prüfen
  if (!Array.isArray(data)) {
    alert("Ungültiges JSON.\nErwartet wird eine JSON-Liste (Array) mit Einträgen.");
    return;
  }

  if (!confirm(`Es werden ${data.length} Einträge importiert. Fortfahren?`)) return;

  // 5) Import: vorhandene mit id -> PUT, neue -> POST
  for (const it of data) {
    await fetch(API, {
      method: it && it.id ? "PUT" : "POST",
      headers: hdrs(),
      body: JSON.stringify(it)
    });
  }

  alert('Import abgeschlossen.');
  loadList();
};

loadList();
</script>
