<!-- ... Kopf & Styles wie bei dir ... -->
<body>
  <!-- ... Topbar & Tabelle wie bei dir ... -->

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    const $ = (s,r=document)=>r.querySelector(s);
    const fmt = iso => iso ? new Date(iso).toLocaleString('de-DE') : '';
    const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
    const esc = s => (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));

    function blobImageUrl(item) {
      if (item?.thumbUrl && /^https?:\/\//.test(item.thumbUrl)) return item.thumbUrl;
      if (item?.imageUrl && /^https?:\/\//.test(item.imageUrl)) return item.imageUrl;
      if (Array.isArray(item?.imageUrls) && item.imageUrls.length && /^https?:\/\//.test(item.imageUrls[0])) {
        return item.imageUrls[0];
      }
      if (item?.thumbUrl) return item.thumbUrl;
      if (Array.isArray(item?.images) && item.images.length) return item.images[0];
      return "";
    }

    async function authedFetch(url,opt={}) {
      const u = netlifyIdentity.currentUser();
      const tok = u && await u.jwt();
      return fetch(url,{...opt,headers:{...(opt.headers||{}),Authorization: tok?`Bearer ${tok}`:''}});
    }

    const cache = new Map();
    let currentView = 'pending';

    (function(){
      const who = $('#who'), btnLogin=$('#btnLogin'), btnLogout=$('#btnLogout');
      function setUser(u){ who.textContent = u ? (u.user_metadata?.full_name || u.email) : 'nicht eingeloggt'; }
      btnLogin.addEventListener('click', ()=> netlifyIdentity.open('login'));
      btnLogout.addEventListener('click', ()=> netlifyIdentity.logout());
      netlifyIdentity.on('init', user=>{
        setUser(user);
        if(!user && location.hash.includes('recovery_token')) netlifyIdentity.open();
        if(user) load('pending');
      });
      netlifyIdentity.on('login', user=>{
        setUser(user);
        netlifyIdentity.close();
        load(currentView);
      });
      netlifyIdentity.on('logout', ()=>{ setUser(null); load('approved'); });
      netlifyIdentity.init();
    })();

    $('#btnRefresh').addEventListener('click', ()=> load(currentView));
    $('#btnShowPending').addEventListener('click', ()=> load('pending'));
    $('#btnShowApproved').addEventListener('click', ()=> load('approved'));

    $('#rows').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.action;
      if(act==='edit') toggleEditor(id, true);
      if(act==='approve') approve(id);
      if(act==='reject') rejectEntry(id);
      if(act==='save') save(id);
      if(act==='cancel') toggleEditor(id, false);
    });

    async function load(view='pending'){
      currentView = view;
      const tbody = $('#rows');
      tbody.innerHTML = `<tr><td colspan="6" class="empty">Lade ${view}‚Ä¶</td></tr>`;
      try{
        const url = `/.netlify/functions/entries-list?status=${encodeURIComponent(view)}`;
        const res = (view==='approved') ? await fetch(url) : await authedFetch(url);
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const items = await res.json();
        cache.clear();
        tbody.innerHTML = items.length? '' : `<tr><td colspan="6" class="empty">Keine Eintr√§ge gefunden.</td></tr>`;
        items.forEach(it=>{ cache.set(it.id, it); tbody.appendChild(row(it, view==='pending')); });
      }catch(err){
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Fehler beim Laden (${esc(err.message)}).</td></tr>`;
      }
    }

    function row(item, showApprove){
      const tr = document.createElement('tr');
      tr.id = `row_${item.id}`;
      const imgSrc = blobImageUrl(item);
      const adr = item.address || ''; // <‚Äî hier: address nutzen

      tr.innerHTML = `
        <td><img class="thumb" src="${esc(imgSrc)}" alt=""></td>
        <td><b>${esc(item.name||'')}</b><div class="muted">${esc(adr||'')}</div></td>
        <td>${esc(item.city||'')}</td>
        <td><span class="tag">${esc(item.category||'-')}</span></td>
        <td>${fmt(item.createdAt)}</td>
        <td>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="btn" data-action="edit" data-id="${item.id}">‚úèÔ∏è Bearbeiten</button>
            ${showApprove? `<button class="btn primary" data-action="approve" data-id="${item.id}">‚úÖ Freigeben</button>`:''}
            <button class="btn danger" data-action="reject" data-id="${item.id}">üóëÔ∏è Ablehnen</button>
          </div>
          <div class="edit" id="edit_${item.id}" style="display:none">
            <div class="field">
              <label>Men√º (optional)</label>
              <textarea id="m_${item.id}">${esc(item.menuText||'')}</textarea>
            </div>
            <div class="field">
              <label>Featured</label>
              <select id="f_${item.id}">
                <option value="false"${item.featured? '':' selected'}>Nein</option>
                <option value="true"${item.featured? ' selected':''}>Ja</option>
              </select>
            </div>
            <div style="grid-column:1/-1;display:flex;gap:8px">
              <button class="btn" data-action="save" data-id="${item.id}">üíæ Speichern</button>
              <button class="btn" data-action="cancel" data-id="${item.id}">Abbrechen</button>
            </div>
          </div>
        </td>`;
      return tr;
    }

    function toggleEditor(id, show){
      const box = document.querySelector(`#edit_${CSS.escape(id)}`);
      if(box) box.style.display = show? 'grid' : 'none';
    }

    async function save(id){
      const menuText = document.querySelector(`#m_${CSS.escape(id)}`)?.value || '';
      const featured = (document.querySelector(`#f_${CSS.escape(id)}`)?.value === 'true');
      try{
        const res = await authedFetch(`/.netlify/functions/entries-update?id=${encodeURIComponent(id)}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ menuText, featured })
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        toast('Gespeichert');
        toggleEditor(id, false);
        load(currentView);
      }catch(e){ toast('Speichern fehlgeschlagen'); }
    }

    async function approve(id){
      try{
        const res = await authedFetch(`/.netlify/functions/entries-update?id=${encodeURIComponent(id)}`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'approve' })
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        toast('Freigeben OK');
        load('pending');
      }catch(e){ toast('Freigabe fehlgeschlagen'); }
    }

    async function rejectEntry(id){
      if(!confirm('Diesen Eintrag wirklich ablehnen?')) return;
      try{
        const res = await authedFetch(`/.netlify/functions/entries-update?id=${encodeURIComponent(id)}`,{
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action:'reject' })
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        toast('Abgelehnt');
        load(currentView);
      }catch(e){ toast('Ablehnen fehlgeschlagen'); }
    }

    document.addEventListener('DOMContentLoaded', ()=> load('approved'));
  </script>
</body>
</html>
