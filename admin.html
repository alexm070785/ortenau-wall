<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ortenau-Wall ¬∑ Admin</title>
  <style>
    :root{--bg:#f6f7f9;--fg:#222;--muted:#6b7280;--card:#fff;--line:#e5e7eb;--primary:#0ea5e9;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--fg);background:var(--bg)}
    .topbar{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    h1{margin:0;font-size:18px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.danger{background:#fff;color:var(--danger);border-color:#fecaca}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    thead th{position:sticky;top:58px;background:#fff;z-index:1;font-size:12px;color:#374151;text-transform:uppercase;letter-spacing:.04em}
    .thumb{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#f3f4f6}
    .muted{color:var(--muted);font-size:12px}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#fafafa;font-size:12px}
    .empty{padding:26px;text-align:center;color:var(--muted)}
    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transition:.2s;z-index:50}
    .toast.show{opacity:1}
    .edit{display:grid;grid-template-columns:1fr 160px;gap:10px;padding:10px;border-top:1px dashed var(--line);background:#fafafa;margin-top:8px;border-radius:8px}
    .field{display:grid;gap:6px}
    .field input,.field select,.field textarea{padding:10px 12px;border:1px solid var(--line);border-radius:10px;font:inherit;width:100%}
    .field textarea{min-height:100px;resize:vertical}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="wrap row">
      <div class="row" style="gap:10px">
        <h1>Ortenau-Wall ¬∑ Admin</h1>
        <span class="pill" id="who">nicht eingeloggt</span>
      </div>
      <div class="row" style="gap:8px">
        <button class="btn" id="btnLogin">üîê Login</button>
        <button class="btn" id="btnRefresh">üîÑ Aktualisieren</button>
        <button class="btn" id="btnLogout">üö™ Logout</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div style="padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">Warteschlange</div>
          <div class="muted">Neue Eintr√§ge, die auf Freigabe warten</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" data-view="pending" id="btnPending">Pending</button>
          <button class="btn" data-view="approved" id="btnApproved">Approved</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:90px">Bild</th>
              <th>Name & Adresse</th>
              <th>Ort</th>
              <th>Kat.</th>
              <th>Eingereicht</th>
              <th style="width:300px">Aktion</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="6" class="empty">Lade‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

  <!-- Netlify Identity Widget -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    // ---------- Helpers ----------
    const $ = (s,r=document)=>r.querySelector(s);
    const esc = s => String(s??'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
    const fmt = iso => iso ? new Date(iso).toLocaleString('de-DE') : '';
    const toast = m => { const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); };

    // authedFetch: jedes Mal ein frisches Token (verhindert 401)
    async function authedFetch(url,opt={}){
      const u = netlifyIdentity.currentUser();
      const tok = u && await u.jwt(true); // true => refresh
      return fetch(url,{...opt,headers:{...(opt.headers||{}),Authorization: tok?`Bearer ${tok}`:''}});
    }

    // ---------- Identity ----------
    (function(){
      const who = $('#who');
      const setUser = (u)=> who.textContent = u ? (u.user_metadata?.full_name || u.email) : 'nicht eingeloggt';

      $('#btnLogin').onclick = ()=> netlifyIdentity.open('login');
      $('#btnLogout').onclick = ()=> netlifyIdentity.logout();
      $('#btnRefresh').onclick = ()=> load(currentView);

      netlifyIdentity.on('init',  u=>{ setUser(u); load('pending'); });
      netlifyIdentity.on('login', u=>{ setUser(u); netlifyIdentity.close(); load(currentView); });
      netlifyIdentity.on('logout',   ()=>{ setUser(null); load('approved'); });
      netlifyIdentity.init();
    })();

    // ---------- State & UI ----------
    let currentView = 'pending';
    const cache = new Map();

    $('#btnPending').onclick  = ()=> load('pending');
    $('#btnApproved').onclick = ()=> load('approved');

    $('#rows').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const id = btn.dataset.id, action = btn.dataset.action;

      if(action==='edit'){ toggleEditor(id,true); return; }
      if(action==='cancel'){ toggleEditor(id,false); return; }

      if(action==='save'){
        const menuText = $(`#m_${CSS.escape(id)}`)?.value || '';
        const featured = ($(`#f_${CSS.escape(id)}`)?.value === 'true');
        const res = await authedFetch(`/.netlify/functions/entries-update?id=${encodeURIComponent(id)}`,{
          method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ menuText, featured })
        });
        toast(res.ok?'Gespeichert':'Fehler beim Speichern');
        toggleEditor(id,false);
        load(currentView);
        return;
      }

      if(action==='approve' || action==='reject'){
        const res = await authedFetch(`/.netlify/functions/entries-update?id=${encodeURIComponent(id)}`,{
          method:'PATCH', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action })
        });
        toast(res.ok ? (action==='approve'?'Freigegeben':'Abgelehnt') : 'Aktion fehlgeschlagen');
        load(currentView);
      }
    });

    function toggleEditor(id,show){
      const box = $(`#edit_${CSS.escape(id)}`);
      if(box) box.style.display = show ? 'grid' : 'none';
    }

    async function load(view='pending'){
      currentView=view;
      const tbody = $('#rows');
      tbody.innerHTML = `<tr><td colspan="6" class="empty">Lade ${view}‚Ä¶</td></tr>`;
      try{
        const url = `/.netlify/functions/entries-list?status=${encodeURIComponent(view)}`;
        const res = (view==='approved') ? await fetch(url) : await authedFetch(url);
        if(!res.ok){ tbody.innerHTML=`<tr><td colspan="6" class="empty">Fehler (${res.status}).</td></tr>`; return; }
        const items = await res.json();
        cache.clear();
        if(!items.length){ tbody.innerHTML=`<tr><td colspan="6" class="empty">Keine Eintr√§ge gefunden.</td></tr>`; return; }
        tbody.innerHTML='';
        items.forEach(it=>{ cache.set(it.id,it); tbody.appendChild(row(it,view==='pending')); });
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" class="empty">Ladefehler.</td></tr>`;
        console.error(e);
      }
    }

    function row(item, showApprove){
      const tr = document.createElement('tr');
      tr.id = `row_${item.id}`;
      const img = item.thumbUrl || (Array.isArray(item.images)&&item.images[0]) || '';
      tr.innerHTML = `
        <td><img class="thumb" src="${esc(img)}" alt=""></td>
        <td><b>${esc(item.name||'')}</b><div class="muted">${esc(item.address||'')}</div></td>
        <td>${esc(item.city||'')}</td>
        <td><span class="tag">${esc(item.category||'-')}</span></td>
        <td>${fmt(item.createdAt)}</td>
        <td>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button class="btn" data-action="edit" data-id="${item.id}">‚úèÔ∏è Bearbeiten</button>
            ${ showApprove ? `<button class="btn primary" data-action="approve" data-id="${item.id}">‚úÖ Freigeben</button>`:''}
            <button class="btn danger" data-action="reject" data-id="${item.id}">üóëÔ∏è Ablehnen</button>
          </div>
          <div class="edit" id="edit_${item.id}" style="display:none">
            <div class="field" style="grid-column:1 / -1">
              <label>Men√º (optional)</label>
              <textarea id="m_${item.id}">${esc(item.menuText||'')}</textarea>
            </div>
            <div class="field">
              <label>Featured</label>
              <select id="f_${item.id}">
                <option value="false"${item.featured? '':' selected'}>Nein</option>
                <option value="true"${item.featured? ' selected':''}>Ja</option>
              </select>
            </div>
            <div class="field" style="align-self:end; justify-self:end">
              <button class="btn" data-action="save" data-id="${item.id}">üíæ Speichern</button>
              <button class="btn" data-action="cancel" data-id="${item.id}">Abbrechen</button>
            </div>
          </div>
        </td>
      `;
      return tr;
    }
  </script>
</body>
</html>
