<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#e7e7e7">
<title>Ortenau liefert · Lokale Angebote</title>
<style>
  :root{ --accent:#e7e7e7; --text:#333; --bg:#f6f6f6; --card:#fff; --muted:#70798C; --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.08); --border:#d0d0d0; --tap:48px; --featured:#fff6f0 }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);line-height:1.45}
  header.site{position:sticky;top:0;z-index:20;background:var(--accent);border-bottom:1px solid #b0b0b0;}
  .head{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;}
  .logo img{height:52px}
  .toolbar{max-width:1200px;margin:8px auto;display:flex;align-items:center;gap:12px;padding:0 16px;}
  @media (max-width:640px){ .toolbar{flex-direction:column;align-items:stretch} }
  .search-wrap{position:relative;display:flex;align-items:center;flex:1}
  #search{width:100%;height:var(--tap);padding:0 46px 0 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
  #clearBtn{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:36px;height:36px;border:0;border-radius:50%;cursor:pointer;background:#f6f6f6;font-size:1.2rem}

  /* Karten – 2 Spalten Desktop, 1 Spalte mobil */
  .grid{max-width:1200px;margin:0 auto 16px;padding:0 16px;display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  .item{display:grid;grid-template-columns:42px 1fr;gap:12px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 12px;text-decoration:none;color:inherit;box-shadow:var(--shadow)}
  .item.featured{background:var(--featured)}
  .emoji{font-size:1.6rem;line-height:1;display:flex;align-items:center;justify-content:center}
  .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:.95rem;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-top:2px}
  .badge{font-size:.85rem;border:1px solid #eee;background:#fafafa;border-radius:999px;padding:2px 8px}
  footer{padding:14px 16px;background:var(--accent);border-top:1px solid #b0b0b0;color:#595959;text-align:center}
</style>
</head>
<body>
<header class="site">
  <div class="head">
    <div class="logo"><a href="index.html" aria-label="Zur Startseite"><img src="header.png" alt="Ortenau liefert"></a></div>
  </div>
</header>

<div class="toolbar">
  <div class="search-wrap" role="search">
    <input id="search" type="search" placeholder="Suche z. B. „Döner Offenburg“" aria-label="Suche" inputmode="search" autocomplete="off">
    <button id="clearBtn" type="button" aria-label="Suche leeren">×</button>
  </div>
</div>

<main class="grid" id="grid"></main>

<footer>© <span id="jahr"></span> Ortenau liefert</footer>

<script>
document.getElementById("jahr").textContent = new Date().getFullYear();

function catEmoji(cat){
  const c = (cat||'').toLowerCase();
  if (c.includes('doener') || c.includes('döner') || c.includes('kebab')) return '🥙';
  if (c.includes('salat')) return '🥗';
  if (c.includes('pizza') || c.includes('pizzeria')) return '🍕';
  if (c.includes('getränk') || c.includes('drinks') || c.includes('trinken')) return '🥤';
  if (c.includes('cafe') || c.includes('café')) return '☕️';
  return '🍽️';
}
const $ = s => document.querySelector(s);
function normalize(s){ try { return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); } catch { return (s||'').toLowerCase(); } }

function render(items){
  const el = $("#grid");
  el.innerHTML = "";
  if(!items.length){ el.innerHTML = '<p class="muted">Keine Einträge gefunden.</p>'; return; }

  // sort: featured zuerst, dann alphabetisch
  const list = [...items].sort((a,b)=>{
    const fa = !!a?.optionen?.featured, fb = !!b?.optionen?.featured;
    if (fa!==fb) return fa? -1 : 1;
    return (a.titel||"").localeCompare(b.titel||"");
  });

  list.forEach(item=>{
    const a = document.createElement('a');
    a.className = 'item' + (item?.optionen?.featured ? ' featured' : '');
    a.href = item.id ? `details.html?id=${encodeURIComponent(item.id)}` : `details.html?q=${encodeURIComponent((item.titel||'').toLowerCase())}`;

    a.innerHTML = `
      <div class="emoji">${catEmoji(item.kategorie)}</div>
      <div>
        <div class="name">${item.titel || ''}</div>
        <div class="sub">
          <span>${item.stadt || item?.adresse?.stadt || ''}</span>
          <span class="badge">${
            ((item.kategorie||'').toLowerCase().includes('doener')||
             (item.kategorie||'').toLowerCase().includes('döner')||
             (item.kategorie||'').toLowerCase().includes('kebab')) ? 'Döner/Kebab'
             : ((item.kategorie||'').toLowerCase().includes('pizza') ? 'Pizza/Pizzeria' : (item.kategorie||'Restaurant'))
          }</span>
        </div>
      </div>`;
    el.appendChild(a);
  });
}

async function loadAndRender(){
  try{
    const res = await fetch("/api/entries",{cache:"no-store"});
    const json = await res.json();
    const all = Array.isArray(json) ? json : (Array.isArray(json?.data) ? json.data : []);
    const input = $("#search"), clear = $("#clearBtn");
    const apply = ()=>{
      const q = normalize(input.value.trim());
      const filtered = !q ? all : all.filter(item=>{
        const hay = normalize(JSON.stringify(item));
        return q.split(/\s+/).filter(Boolean).every(t=>hay.includes(t));
      });
      render(filtered);
    };
    input.oninput = apply; clear.onclick = ()=>{ input.value=""; apply(); input.focus(); };
    apply();
  }catch(e){
    console.error(e);
    render([]);
  }
}
loadAndRender();
</script>
</body>
</html>
