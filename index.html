<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#e7e7e7">
<title>Ortenau liefert · Lokale Angebote</title>

<link rel="manifest" href="/manifest.webmanifest">
<link rel="icon" href="/favicon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Ortenau liefert">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<style>
  :root{ --accent:#e7e7e7; --text:#333; --bg:#f6f6f6; --card:#fff; --muted:#70798C; --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.08); --border:#d0d0d0; --tap:48px; }
  *{box-sizing:border-box}
  html{font-size:16px}
  @media (max-width:480px){ html{font-size:17px} }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);padding-bottom:56px;line-height:1.45}
  .visually-hidden{position:absolute!important;width:1px;height:1px;margin:-1px;padding:0;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}

  header.site{position:sticky;top:0;z-index:20;background:var(--accent);border-bottom:1px solid #b0b0b0;}
  .head{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;}
  .logo img{height:52px}
  .hamburger{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:10px;background:#fff;border:1px solid var(--border);cursor:pointer}
  .hamburger svg{width:24px;height:24px}

  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .2s;z-index:19}
  .backdrop.show{opacity:1;pointer-events:auto}
  .drawer{position:fixed;top:0;right:-280px;width:280px;height:100%;background:#fff;border-left:1px solid var(--border);box-shadow:-12px 0 24px rgba(0,0,0,.18);transition:right .25s;z-index:20;display:flex;flex-direction:column}
  .drawer.show{right:0}
  .drawer header{border-bottom:1px solid var(--border);padding:12px 14px;font-weight:700}
  .menu{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
  .menu a{text-decoration:none;color:var(--text);padding:10px 12px;border-radius:10px;display:block;border:1px solid #eee;background:#fafafa}
  .menu a:hover{background:#f2f2f2}

  .toolbar{ max-width:900px; margin:8px auto; display:flex; align-items:center; gap:12px; padding:0 16px; }
  @media (max-width:640px){ .toolbar{flex-direction:column;align-items:stretch} }
  .search-wrap{position:relative;display:flex;align-items:center;flex:1}
  .search-wrap svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none}
  #search{width:100%;height:var(--tap);padding:0 46px 0 40px;border:1px solid var(--border);border-radius:12px;background:#fff;color:var(--text)}
  #clearBtn{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:36px;height:36px;border:0;border-radius:50%;cursor:pointer;background:#f6f6f6;font-size:1.2rem}

  .install{height:var(--tap);padding:0 14px;border:1px solid var(--border);border-radius:12px;background:#fff;cursor:pointer;box-shadow:var(--shadow)}
  @media (max-width:640px){ .install{width:100%;} }

  .ios-install-hint { display:none;background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);padding:10px 12px;gap:8px;align-items:center;justify-content:space-between;font-size:.95rem;margin:8px 16px 0; }
  .ios-install-hint .close { border:0;background:#f1f1f1;border-radius:10px;padding:6px 10px;cursor:pointer }
  .ios-share-emoji { font-size:1.2rem }

  .list{ max-width:900px; margin:0 auto 12px; padding:0 16px; display:grid; grid-template-columns:1fr; gap:12px; }
  @media (min-width:640px){ .list{ grid-template-columns:repeat(2, minmax(0, 1fr)); } }

  .item{ display:grid; grid-template-columns:42px 1fr; gap:12px; align-items:center; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; text-decoration:none; color:inherit; box-shadow:var(--shadow); min-height:64px; }
  .item:active{transform:scale(.99)}
  .emoji{font-size:1.6rem;line-height:1;display:flex;align-items:center;justify-content:center}
  .meta{min-width:0}
  .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:.95rem;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap;margin-top:2px}
  .badge{font-size:.85rem;border:1px solid #eee;background:#fafafa;border-radius:999px;padding:2px 8px}

  footer{position:fixed;bottom:0;left:0;width:100%;height:56px;background:var(--accent);color:#595959;border-top:1px solid #b0b0b0;font-size:.95rem}
  .footer-inner{max-width:900px;margin:0 auto;height:100%;display:flex;justify-content:center;align-items:center;padding:0 12px}

  /* Werbung */
  .ad-card{ position:relative; border:1px solid #e9d88c; background:linear-gradient(180deg,#fffdf4,#ffffff); min-height:96px; cursor:pointer; }
  @media (min-width:640px){ .ad-card{ grid-row: span 2; min-height:150px; } }
  .ad-card::after{
    content:"WERBUNG";
    position:absolute; top:8px; right:10px;
    font-size:.72rem; color:#7a5d00;
    background:#fff5bf; border:1px solid #ecd972; border-radius:999px; padding:2px 8px;
    pointer-events:none;
  }
  .ad-card{ grid-template-columns:1fr; }
  .ad-card .emoji{ position:absolute; top:12px; left:12px; width:44px; height:44px; }
  .ad-card .emoji img{ width:44px; height:44px; border-radius:8px; object-fit:cover; display:block; }
  .ad-card .meta{ margin-left:60px; }
  .ad-card .ad-text{ margin-top:6px; color:#555; font-size:.95rem; white-space:pre-wrap; }

  /* Platzhalter-Werbung */
  .ad-placeholder{ border:1px dashed #e2c964; background:linear-gradient(180deg,#fffef8,#ffffff); }
  .ad-placeholder::after{ content:"WERBEPLATZ"; background:#ffeeb5; }
  .ad-placeholder .name{ color:#7a5d00 }
  .ad-placeholder .ad-text{ color:#7a5d00; opacity:.9 }
</style>
</head>
<body>
<header class="site">
  <div class="head">
    <div class="logo"><a href="index.html" aria-label="Zur Startseite"><img src="header.png" alt="Ortenau liefert"></a></div>
    <button class="hamburger" id="menuBtn" aria-label="Menü öffnen" aria-expanded="false" aria-controls="drawer">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="#333" d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
    </button>
  </div>
</header>

<div class="backdrop" id="backdrop" hidden></div>
<aside class="drawer" id="drawer" role="dialog" aria-modal="true" aria-hidden="true">
  <header>Menü</header>
  <nav class="menu">
    <a href="index.html">Startseite</a>
    <a href="kontakt.html">Kontakt</a>
    <a href="impressum.html">Impressum</a>
    <a href="agb.html">AGB</a>
    <a href="datenschutz.html">Datenschutz</a>
  </nav>
</aside>

<div class="toolbar">
  <div class="search-wrap" role="search">
    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="#9a9a9a" d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 0 0 1.57-4.23C16 6.01 13.99 4 11.5 4S7 6.01 7 9.5 9.01 15 11.5 15c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-4 0C9.01 14 7 11.99 7 9.5S9.01 5 11.5 5 16 7.01 16 9.5 13.99 14 11.5 14z"/></svg>
    <input id="search" type="search" placeholder="Suche z. B. „Döner Offenburg“" aria-label="Suche" inputmode="search" autocomplete="off">
    <button id="clearBtn" type="button" aria-label="Suche leeren">×</button>
  </div>
  <button id="installBtn" class="install" type="button" hidden>+ App installieren</button>
</div>

<main class="list" id="list"></main>

<footer><div class="footer-inner">© <span id="jahr"></span> Ortenau liefert</div></footer>

<script>
document.getElementById("jahr").textContent = new Date().getFullYear();

// Drawer
(function(){
  const menuBtn = document.getElementById('menuBtn');
  const drawer = document.getElementById('drawer');
  const backdrop = document.getElementById('backdrop');
  function open(){ drawer.classList.add('show'); drawer.setAttribute('aria-hidden','false'); backdrop.hidden=false; requestAnimationFrame(()=>backdrop.classList.add('show')); menuBtn.setAttribute('aria-expanded','true'); }
  function close(){ drawer.classList.remove('show'); drawer.setAttribute('aria-hidden','true'); backdrop.classList.remove('show'); menuBtn.setAttribute('aria-expanded','false'); setTimeout(()=>backdrop.hidden=true,200); }
  menuBtn.addEventListener('click', open);
  backdrop.addEventListener('click', close);
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
})();

// Kategorie-Emoji
function catEmoji(cat){
  const c = (cat||'').toLowerCase();
  if (c.includes('doener') || c.includes('döner') || c.includes('kebab')) return '🥙';
  if (c.includes('salat')) return '🥗';
  if (c.includes('pizza') || c.includes('pizzeria')) return '🍕';
  if (c.includes('getränk') || c.includes('drinks') || c.includes('trinken')) return '🥤';
  if (c.includes('cafe') || c.includes('café')) return '☕️';
  return '🍽️';
}

const $ = s => document.querySelector(s);
function normalize(s){ try { return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); } catch { return (s||'').toLowerCase(); } }

/* ===== Datums-Parsing ===== */
function parseDateLoose(v){
  if (!v) return null;
  if (v instanceof Date) return isNaN(v)?null:v;
  if (typeof v === 'number') { const d = new Date(v); return isNaN(d)?null:d; }
  const s = String(v).trim();
  if (!s) return null;
  const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
  if (m){
    const dd = +m[1], MM = +m[2]-1; let yyyy = +m[3]; if (yyyy<100) yyyy+=2000;
    const hh = m[4]? +m[4]:0, mi = m[5]? +m[5]:0;
    const d = new Date(yyyy,MM,dd,hh,mi,0,0);
    return isNaN(d)?null:d;
  }
  const d = new Date(s);
  return isNaN(d)?null:d;
}
function parseDateLooseEnd(v){
  if (!v) return null;
  const s = String(v).trim();
  const m = s.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2,4})(?:\s+(\d{1,2}):(\d{2}))?$/);
  if (m && !m[4]){
    const dd = +m[1], MM = +m[2]-1; let yyyy = +m[3]; if (yyyy<100) yyyy+=2000;
    const d = new Date(yyyy,MM,dd,23,59,59,999);
    return isNaN(d)?null:d;
  }
  return parseDateLoose(v);
}

/* ===== Werbung: Laden + Auswahl + 3 Slots Rotation ===== */
async function fetchAds(){
  try{
    const r = await fetch("/api/ads", { cache:"no-store" });
    const j = await r.json();
    return Array.isArray(j) ? j : [];
  }catch(e){
    console.warn("[ads] fetch failed", e);
    return [];
  }
}
function isAdActiveLoose(ad){
  if (ad.active === false) return false;
  const status = String(ad.status ?? ad.Status ?? ad.state ?? "").toLowerCase();
  if (status && status !== "aktiv" && status !== "active") return false;

  const now = new Date();
  const startVal = ad.start ?? ad.begin ?? ad.startDate ?? ad.von ?? ad.beginn;
  const endVal   = ad.ende  ?? ad.end   ?? ad.endDate   ?? ad.bis  ?? ad.endeDatum;

  const ds = parseDateLoose(startVal);
  const de = parseDateLooseEnd(endVal);

  if (ds && ds > now) return false;
  if (de && de < now) return false;
  return true;
}
function pickUrl(ad){
  const cands = [
    'link','url','clickUrl','click','klick','klickUrl',
    'target','targetUrl','target_url','href',
    'ZielURL','ZielUrl','ziel','zielurl','ziel_url'
  ];
  let u = '';
  for (const k of cands){
    if (ad[k]) { u = String(ad[k]).trim(); break; }
  }
  if (!u) return '';
  if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
  return u;
}
function buildAdCard(ad, isPlaceholder=false){
  const title = isPlaceholder ? "Jetzt werben auf ORTENAU LIEFERT" : (ad.title ?? ad.titel ?? "Anzeige");
  const image = isPlaceholder ? "" : (ad.image ?? ad.bild ?? ad.img ?? ad.imageUrl ?? ad.bildUrl ?? "");
  const url   = isPlaceholder ? "/werbung.html" : pickUrl(ad);

  const a = document.createElement('a');
  a.className = 'item ad-card' + (isPlaceholder ? ' ad-placeholder' : '');

  if (url){
    a.href = url;
    a.target = "_blank";
    a.rel = "noopener";
  } else {
    a.setAttribute('role','button');
    a.style.cursor = 'default';
  }

  const emoji = document.createElement('div');
  emoji.className = 'emoji';
  if (!isPlaceholder && image) emoji.innerHTML = `<img src="${image}" alt="">`;
  else emoji.textContent = isPlaceholder ? "📣" : "💡";

  const meta = document.createElement('div');
  meta.className = 'meta';
  const name = document.createElement('div');
  name.className = 'name';
  name.textContent = title;

  const text = document.createElement('div');
  text.className = 'ad-text';
  if (isPlaceholder){
    text.innerHTML = "Ihre Reichweite in der Ortenau!<br>Präsenter Werbeplatz direkt auf der Startseite.<br><b>Klicken</b> und unverbindlich anfragen.";
  } else {
    const t = ad.text ?? ad.beschreibung ?? "";
    if (String(t).trim()) text.innerHTML = String(t).replace(/\n/g,"<br>");
  }

  meta.appendChild(name);
  if (text.innerHTML) meta.appendChild(text);

  a.appendChild(emoji);
  a.appendChild(meta);
  return a;
}

/* Rotations-Controller */
const AD_SLOT_POSITIONS = [3, 9, 15];
const ROTATE_INTERVAL_MS = 15000;
let adRotation = { list: [], idx: 0, timer: null };

function clearCurrentAdCards(host){
  host.querySelectorAll('.ad-card').forEach(el => el.remove());
}

/* NEU: nie doppelte Anzeigen – fehlende Plätze mit Platzhaltern füllen */
function pickThree(ads){
  if (!ads.length) return [];
  const out = [];
  const used = new Set();
  let offset = 0;
  while (out.length < 3 && offset < ads.length){
    const cand = ads[(adRotation.idx + offset) % ads.length];
    if (cand && !used.has(cand.id)){
      out.push(cand);
      used.add(cand.id);
    }
    offset++;
    if (used.size === ads.length) break; // alle einmal genutzt -> stoppen
  }
  return out; // <3 möglich – Rest wird als Platzhalter ergänzt
}

function insertAdCards(host, cards){
  AD_SLOT_POSITIONS.forEach((pos, i) => {
    const card = cards[i] || buildAdCard(null, true);
    const ref = host.children[pos] || null;
    host.insertBefore(card, ref);
  });
}

async function initAdRotation(host){
  const all = (await fetchAds()).filter(isAdActiveLoose);
  const wantKey = "home_right_mid";
  const slotMatch = a => {
    const p = a.positions;
    const s = a.slot ?? a.slotKey ?? a.position ?? "";
    if (Array.isArray(p) && p.length) return p.some(x => String(x).includes(wantKey));
    return String(s).includes(wantKey);
  };
  const wanted = all.filter(slotMatch);
  adRotation.list = (wanted.length ? wanted : all).slice();

  if (adRotation.list.length) {
    adRotation.idx = Math.floor(Math.random() * adRotation.list.length);
  } else {
    adRotation.idx = 0;
  }

  clearCurrentAdCards(host);
  const three = pickThree(adRotation.list);
  const cards = [0,1,2].map(i => three[i] ? buildAdCard(three[i]) : buildAdCard(null,true));
  insertAdCards(host, cards);

  if (adRotation.timer) clearInterval(adRotation.timer);
  adRotation.timer = setInterval(()=>{
    // Schrittweite: 1..3 je nach verfügbarer Anzahl, damit sinnvoll rotiert wird
    const step = Math.max(1, Math.min(3, adRotation.list.length));
    if (!adRotation.list.length){
      clearCurrentAdCards(host);
      insertAdCards(host, [buildAdCard(null,true), buildAdCard(null,true), buildAdCard(null,true)]);
      return;
    }
    adRotation.idx = (adRotation.idx + step) % adRotation.list.length;
    clearCurrentAdCards(host);
    const nextThree = pickThree(adRotation.list);
    insertAdCards(host, [0,1,2].map(i => nextThree[i] ? buildAdCard(nextThree[i]) : buildAdCard(null,true)));
  }, ROTATE_INTERVAL_MS);
}

/* ===== Liste rendern ===== */
function render(items){
  const el = $("#list");
  el.innerHTML = "";
  if(!items.length){ el.innerHTML = '<p class="muted" style="padding:12px">Noch keine Einträge vorhanden.</p>'; return; }

  const list = [...items].sort((a,b)=>{
    const fa = !!a?.optionen?.featured, fb = !!b?.optionen?.featured;
    if (fa!==fb) return fa? -1 : 1;
    return (a.titel||"").localeCompare(b.titel||"");
  });

  list.forEach(item=>{
    const a = document.createElement('a');
    a.className = 'item';
    a.href = item.id ? `details.html?id=${encodeURIComponent(item.id)}` : `details.html?q=${encodeURIComponent((item.titel||'').toLowerCase())}`;
    const emoji = document.createElement('div');
    emoji.className = 'emoji';
    emoji.textContent = catEmoji(item.kategorie);
    const meta = document.createElement('div');
    meta.className = 'meta';
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = item.titel || '';
    const sub = document.createElement('div');
    sub.className = 'sub';
    const city = item.stadt || item?.adresse?.stadt || '';
    const rawCat = (item.kategorie||'').toLowerCase();
    let catLabel = rawCat;
    if (rawCat.includes('doener') || rawCat.includes('döner') || rawCat.includes('kebab')) catLabel = 'Döner/Kebab';
    else if (rawCat.includes('pizza')) catLabel = 'Pizza/Pizzeria';
    else if (!catLabel) catLabel = 'Restaurant';
    sub.innerHTML = `<span>${city ? city : ''}</span><span class="badge">${catLabel}</span>`;
    meta.appendChild(name);
    meta.appendChild(sub);
    a.appendChild(emoji);
    a.appendChild(meta);
    el.appendChild(a);
  });
}

/* ===== Daten + Suche ===== */
async function loadAndRender(){
  const res = await fetch("/api/entries");
  const all = await res.json();
  const input = $("#search");
  const clear = $("#clearBtn");
  async function apply(){
    const q = normalize(input.value.trim());
    const filtered = !q ? all : all.filter(item=>{
      const hay = normalize(JSON.stringify(item));
      return q.split(/\s+/).filter(Boolean).every(t=>hay.includes(t));
    });
    render(filtered);
    const host = document.getElementById("list");
    await initAdRotation(host);
  }
  input.oninput = apply;
  clear.onclick = ()=>{ input.value=""; apply(); input.focus(); };
  await apply();
}
loadAndRender();
</script>
</body>
</html>
