<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ortenau-Wall</title>
  <style>
    :root{--line:#e5e7eb;--muted:#6b7280}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--line)}
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px}
    .thumb{width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    #adminLink{display:none;margin-left:12px}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Ortenau-Wall</h1>
    <nav>
      <a href="/eintragen.html">‚ûï Lokal eintragen</a>
      <a id="adminLink" href="/admin.html">üõ†Ô∏è Admin</a>
    </nav>
  </header>

  <main class="wrap">
    <!-- ======= DEIN BISHERIGER INHALT =======
         Lass hier deinen bestehenden Content/Bl√∂cke.
         Der folgende Bereich "#approved" ist optional: wenn vorhanden,
         wird er automatisch mit freigegebenen Eintr√§gen gef√ºllt. -->
    <h2>Empfohlene Orte</h2>
    <p class="muted">Diese Liste zeigt automatisch Eintr√§ge mit Status ‚Äûapproved‚Äú.</p>

    <div id="approved" class="grid">
      <!-- Karten werden per JS eingef√ºgt -->
    </div>
    <!-- ======= ENDE DEIN INHALT ======= -->
  </main>

  <!-- Netlify Identity: minimal & stabil (kein Redirect) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script>
    // Identity initialisieren, damit Reset-/Confirm-Links funktionieren
    if (window.netlifyIdentity) {
      netlifyIdentity.on('init', (user) => {
        // Admin-Link nur zeigen, wenn eingeloggt
        const al = document.getElementById('adminLink');
        if (al) al.style.display = user ? 'inline' : 'none';

        // Wenn ein Wiederherstellungs-/Best√§tigungs-Token im Hash ist -> Dialog √∂ffnen
        if (!user && (location.hash.includes('recovery_token') || location.hash.includes('confirmation_token'))) {
          netlifyIdentity.open();
          // Nach erfolgreichem Login Dialog schlie√üen (KEIN Redirect)
          netlifyIdentity.on('login', () => netlifyIdentity.close());
        }
      });
      netlifyIdentity.init();
    }
  </script>

  <!-- Approved-Eintr√§ge laden (√∂ffentlich) -->
  <script>
    (async function loadApproved(){
      const wrap = document.getElementById('approved');
      if (!wrap) return; // nichts zu tun, wenn Container nicht existiert
      wrap.innerHTML = '<div class="muted">Lade‚Ä¶</div>';
      try {
        const res = await fetch('/.netlify/functions/entries-list?status=approved');
        if (!res.ok) throw new Error('HTTP '+res.status);
        const items = await res.json();
        if (!items.length) { wrap.innerHTML = '<div class="muted">Noch keine freigegebenen Eintr√§ge.</div>'; return; }
        wrap.innerHTML = '';
        items.forEach(it => {
          const el = document.createElement('article');
          el.className = 'card';
          el.innerHTML = `
            <img class="thumb" src="${esc(it.thumbUrl||it.imageUrl||'')}" alt="">
            <h3>${esc(it.name||'')}</h3>
            <div class="muted">${esc(it.category||'-')} ¬∑ ${esc(it.city||'')}</div>
            <div>${esc(it.address||'')}</div>
            ${it.website ? `<div><a href="${esc(it.website)}" target="_blank" rel="noopener">Website</a></div>` : ''}
          `;
          wrap.appendChild(el);
        });
      } catch (e) {
        wrap.innerHTML = '<div class="muted">Fehler beim Laden.</div>';
        console.error(e);
      }
      function esc(s){return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    })();
  </script>
</body>
</html>
