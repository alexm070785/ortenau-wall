<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#e7e7e7">
<title>Ortenau liefert ¬∑ Detail</title>
<style>
  :root{ --accent:#e7e7e7; --text:#333; --bg:#f6f6f6; --card:#fff; --border:#d0d0d0; --muted:#70798C; --shadow:0 4px 12px rgba(0,0,0,.08); --radius:14px; --badge:#f2f2f2; --tap:48px; --mono: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace }
  *{box-sizing:border-box}
  html{font-size:16px}
  @media (max-width:480px){ html{font-size:17px} }
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5}
  header{position:sticky;top:0;background:var(--accent);border-bottom:1px solid #b0b0b0;z-index:5}
  .head{max-width:1200px;margin:auto;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 16px}
  .head img{height:48px}
  a.back{display:inline-flex;align-items:center;gap:8px;text-decoration:none;color:#222;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);min-height:var(--tap)}
  a.back:active{transform:scale(.99)}
  main{max-width:1100px;margin:18px auto;padding:0 16px;display:grid;gap:16px;grid-template-columns:2fr 1fr}
  @media (max-width:900px){ main{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  h1{margin:0 0 8px;font-size:clamp(1.2rem, 1rem + 1.5vw, 1.8rem)}
  .muted{color:var(--muted)}
  .badge{display:inline-block; background:var(--badge); border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:.9rem; margin-right:6px}
  .section h2{margin:0 0 8px;font-size:1.05rem}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:6px}
  .kv div{padding:4px 0}
  @media (max-width:560px){ .kv{grid-template-columns:1fr} .kv div:first-child{font-weight:600} }
  .links a{display:inline-flex;align-items:center;justify-content:center;min-height:var(--tap);margin:6px 6px 0 0;text-decoration:none;border:1px solid var(--border);border-radius:999px;padding:8px 12px;background:#fff}
  .hero{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .emoji-hero{font-size:64px;line-height:1;display:flex;align-items:center;justify-content:center;width:120px;height:120px;border-radius:16px;border:1px solid var(--border);background:#fff}
  @media (max-width:480px){ .emoji-hero{font-size:56px;width:100px;height:100px} }
  .cta-bar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .cta-bar a{display:inline-flex;align-items:center;justify-content:center;min-height:var(--tap);padding:10px 14px;border-radius:12px;text-decoration:none;border:1px solid var(--border);background:#fff}

  /* Speisekarte kompakt */
  details.menu{margin-top:14px}
  details.menu summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff;user-select:none}
  details.menu summary::-webkit-details-marker{display:none}
  .menu-body{margin-top:10px}
  .menu-item{background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 10px;margin-bottom:6px}
  .menu-head{font-weight:700;margin:10px 0 6px}
  .menu-text{white-space:pre-wrap;font-family:var(--mono)}
  .note{font-size:.95rem;color:var(--muted);margin-top:8px}
</style>
</head>
<body>
<header>
  <div class="head">
    <a class="back" href="index.html" aria-label="Zur √úbersicht">‚Üê Zur √úbersicht</a>
    <img src="header.png" alt="Ortenau liefert" height="48">
  </div>
</header>

<main>
  <article class="card" id="detail">
    <div class="hero">
      <div id="emoji" class="emoji-hero" aria-hidden="true">üçΩÔ∏è</div>
      <div>
        <h1 id="titel">Lokal</h1>
        <div id="kategorie" class="badge">Kategorie</div>
        <div id="badges" style="margin-top:6px"></div>
        <div id="ort" class="muted" style="margin-top:4px"></div>
        <div class="cta-bar" id="ctaBar"></div>
      </div>
    </div>

    <section class="section" id="sec-hours" style="margin-top:14px">
      <h2>√ñffnungszeiten & Hinweise</h2>
      <div class="kv">
        <div class="muted">√ñffnungszeiten</div><div id="oeffnungszeiten">‚Äì</div>
        <div class="muted">Schlie√ütage</div><div id="schliesstage">‚Äì</div>
      </div>
    </section>

    <section class="section" id="sec-contact" style="margin-top:14px">
      <h2>Kontakt & Adresse</h2>
      <div class="kv" id="kv-contact">
        <div class="muted">Adresse</div><div id="adresse">‚Äì</div>
        <div class="muted">Telefon</div><div id="telefon">‚Äì</div>
        <div class="muted">E-Mail</div><div id="email">‚Äì</div>
      </div>
    </section>

    <section class="section" id="sec-desc" style="margin-top:14px">
      <h2>Beschreibung</h2>
      <div id="beschreibung">‚Äì</div>
    </section>

    <!-- SPEISEKARTE -->
    <details class="menu section" id="sec-menu">
      <summary>üçΩÔ∏è Speisekarte anzeigen / ausblenden</summary>
      <div class="menu-body" id="menuBody"></div>
      <div class="note" id="priceNote" style="display:none">Hinweis: Wir nennen hier bewusst keine Preise, da sich diese bei den Anbietern h√§ufig √§ndern.</div>
    </details>
  </article>

  <aside class="card" id="sec-links">
    <h2 style="margin:0 0 8px">Links</h2>
    <div class="links" id="links"></div>
  </aside>
</main>

<script>
function getParam(name){ const u = new URL(location.href); return u.searchParams.get(name); }
function textOrEmpty(v){ return v && String(v).trim() ? v.trim() : ""; }
function esc(s){ return (s||"").replace(/[&<>"]/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;", "\"":"&quot;" }[m])); }
function telLink(num){ const n=(num||"").replace(/\s+/g,''); return n ? `tel:${encodeURIComponent(n)}` : ""; }
function mailLink(m){ return m ? `mailto:${encodeURIComponent(m)}` : ""; }

function catEmoji(cat){
  const c = (cat||'').toLowerCase();
  if (c.includes('doener') || c.includes('d√∂ner') || c.includes('kebab')) return 'ü•ô';
  if (c.includes('salat')) return 'ü•ó';
  if (c.includes('pizza') || c.includes('pizzeria')) return 'üçï';
  if (c.includes('getr√§nk') || c.includes('drinks') || c.includes('trinken')) return 'ü•§';
  if (c.includes('cafe') || c.includes('caf√©')) return '‚òïÔ∏è';
  return 'üçΩÔ∏è';
}

/* Speisekarte-Renderer: trennt Abschnitte + Items dezent */
function renderMenuBlocks(raw){
  const $sec = document.getElementById('sec-menu');
  const body = document.getElementById('menuBody');
  const note = document.getElementById('priceNote');
  body.innerHTML = '';
  note.style.display = 'none';

  if(!raw || !raw.trim()){ $sec.style.display = 'none'; return; }
  $sec.style.display = '';

  const lines = raw.replace(/\r\n/g,"\n").split("\n");
  const headRe = /^[\u{1F300}-\u{1FAFF}]/u; // Emoji am Zeilenanfang
  let buffer = [], haveAny = false;

  function addHead(t){
    const h = document.createElement('div');
    h.className = 'menu-head';
    h.textContent = t;
    body.appendChild(h);
  }
  function addItem(text){
    const d = document.createElement('div');
    d.className = 'menu-item';
    d.innerHTML = `<div class="menu-text">${esc(text)}</div>`;
    body.appendChild(d);
    haveAny = true;
  }
  function flush(){ const t = buffer.join("\n").trim(); if(t) addItem(t); buffer = []; }

  for(let i=0;i<lines.length;i++){
    const l = lines[i].trim();
    if(!l){ flush(); continue; }

    // √úberschrift, wenn Emoji oder (kurze Zeile ohne Preis + neuer Block)
    const isHead = headRe.test(l) || (!/[0-9‚Ç¨]/.test(l) && l.length < 60 && buffer.length===0);
    if(isHead){ flush(); addHead(l); continue; }

    // Zeile + n√§chste Zeile Preis? -> zusammenfassen
    const nx = lines[i+1]?.trim() || "";
    const looksPrice = /‚Ç¨|\d,\d{2}/.test(nx);
    if(!/‚Ç¨|\d,\d{2}/.test(l) && looksPrice){ buffer.push(l); buffer.push(nx); i++; flush(); }
    else { buffer.push(l); flush(); }
  }
  flush();
  if (haveAny) note.style.display = 'block';
}

(async function(){
  // Daten laden
  const id = getParam('id');
  const q  = getParam('q');
  const res = await fetch('/api/entries', { cache:'no-store' });
  const data = await res.json();

  // Eintrag finden
  let item = null;
  if (id) item = data.find(x => x.id === id);
  if (!item && q) item = data.find(x => (x.titel||'').toLowerCase().includes(q.toLowerCase()));

  if (!item) {
    document.getElementById('detail').innerHTML = '<p class="muted">Eintrag nicht gefunden.</p>';
    document.getElementById('sec-links').style.display = 'none';
    return;
  }

  /* Hero: Emoji + Titel + Kategorie + Badges + Ort */
  document.getElementById('emoji').textContent = catEmoji(item.kategorie);
  document.getElementById('titel').textContent = item.titel || 'Lokal';

  // Kategorie-Label vereinheitlichen
  const rawCat = (item.kategorie||'').toLowerCase();
  let catLabel = rawCat;
  if (rawCat.includes('doener') || rawCat.includes('d√∂ner') || rawCat.includes('kebab')) catLabel = 'D√∂ner/Kebab';
  else if (rawCat.includes('pizza')) catLabel = 'Pizza/Pizzeria';
  else if (!catLabel) catLabel = 'Restaurant';
  document.getElementById('kategorie').textContent = catLabel;

  // Ort
  const ort = item.stadt || item?.adresse?.stadt || '';
  document.getElementById('ort').textContent = ort ? ort : '';

  // Badges (Abholung/Lieferung)
  const $badges = document.getElementById('badges');
  $badges.innerHTML = '';
  if (item?.optionen?.abholung){
    const b = document.createElement('span'); b.className='badge'; b.textContent='Abholung'; $badges.appendChild(b);
  }
  if (item?.optionen?.lieferung){
    const b = document.createElement('span'); b.className='badge'; b.textContent='Lieferung'; $badges.appendChild(b);
  }

  /* √ñffnungszeiten / Hinweise */
  const open = textOrEmpty(item?.info?.oeffnungszeiten);
  const shut = textOrEmpty(item?.info?.schliesstage);
  document.getElementById('oeffnungszeiten').textContent = open || '‚Äì';
  document.getElementById('schliesstage').textContent   = shut || '‚Äì';
  if(!open && !shut) document.getElementById('sec-hours').style.display='none';

  /* Kontakt & Adresse */
  const adr = [
    textOrEmpty(item?.adresse?.strasse),
    [ textOrEmpty(item?.adresse?.plz), textOrEmpty(item?.adresse?.stadt || item?.stadt) ].filter(Boolean).join(' ')
  ].filter(Boolean).join(', ');
  const tel  = textOrEmpty(item?.kontakt?.telefon);
  const mail = textOrEmpty(item?.kontakt?.email);

  const $adr = document.getElementById('adresse');
  const $tel = document.getElementById('telefon');
  const $eml = document.getElementById('email');

  if (adr) $adr.textContent = adr; else $adr.parentElement.previousElementSibling.remove(); $adr.parentElement.remove();
  if (tel) $tel.innerHTML = `<a href="${telLink(tel)}">${esc(tel)}</a>`; else $tel.parentElement.previousElementSibling.remove(); $tel.parentElement.remove();
  if (mail) $eml.innerHTML = `<a href="${mailLink(mail)}">${esc(mail)}</a>`; else $eml.parentElement.previousElementSibling.remove(); $eml.parentElement.remove();

  // Wenn gar nichts √ºbrig ist ‚Üí Sektion verbergen
  if (!adr && !tel && !mail) document.getElementById('sec-contact').style.display='none';

  /* Beschreibung */
  const desc = textOrEmpty(item?.info?.beschreibung);
  if (desc) document.getElementById('beschreibung').textContent = desc;
  else document.getElementById('sec-desc').style.display='none';

  /* CTA-Buttons (z. B. externe Seite) */
  const $cta = document.getElementById('ctaBar');
  $cta.innerHTML = '';
  if (item.url){
    const a = document.createElement('a');
    a.href = item.url; a.target='_blank'; a.rel='noopener';
    a.textContent = 'Zur Seite / Bestellen';
    $cta.appendChild(a);
  }

  /* Links (Website, Speisekarte, Socials) */
  const links = [];
  if (item?.web?.website)     links.push({label:'Website',     url:item.web.website});
  if (item?.web?.speisekarte) links.push({label:'Speisekarte', url:item.web.speisekarte});
  if (item?.web?.instagram)   links.push({label:'Instagram',   url:item.web.instagram});
  if (item?.web?.facebook)    links.push({label:'Facebook',    url:item.web.facebook});
  if (item?.web?.tiktok)      links.push({label:'TikTok',      url:item.web.tiktok});

  const $links = document.getElementById('links');
  $links.innerHTML = '';
  if (!links.length){
    document.getElementById('sec-links').style.display = 'none';
  } else {
    links.forEach(l=>{
      const a = document.createElement('a');
      a.href = l.url; a.target = '_blank'; a.rel='noopener';
      a.textContent = l.label;
      $links.appendChild(a);
    });
  }

  /* Speisekarte */
  renderMenuBlocks(item?.menu?.text || '');
})();
</script>
